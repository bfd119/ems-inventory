<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
   EMSåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2 - Claudeé¢¨ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================ */

        :root {
            /* Claudeé¢¨ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --color-bg-primary: #faf9f7;
            --color-bg-secondary: #f5f4f0;
            --color-bg-tertiary: #e8e6e1;
            --color-bg-card: #ffffff;
            --color-bg-card-hover: #fefdfb;
            --color-text-primary: #1a1a1a;
            --color-text-secondary: #5c5c5c;
            --color-text-muted: #8c8c8c;
            --color-accent-primary: #d97706;
            --color-accent-secondary: #ea580c;
            --color-accent-gradient: linear-gradient(135deg, #d97706, #ea580c);
            --color-success: #16a34a;
            --color-warning: #ca8a04;
            --color-danger: #dc2626;
            --color-in: #16a34a;
            --color-out: #dc2626;
            --color-border: rgba(0, 0, 0, 0.08);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --font-family: 'Noto Sans JP', sans-serif;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            line-height: 1.5;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
            color: inherit;
        }

        input,
        select {
            font-family: inherit;
            font-size: 1rem;
        }

        .screen {
            display: none;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            padding: var(--spacing-md);
            animation: fadeIn var(--transition-normal);
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(250, 249, 247, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-bg-tertiary);
            border-top-color: var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* éƒ¨ç½²é¸æŠç”»é¢ */
        #department-select {
            justify-content: center;
            align-items: center;
            gap: var(--spacing-xl);
        }

        .screen-header {
            text-align: center;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            color: var(--color-accent-primary);
        }

        .title-icon {
            font-size: 1.75rem;
        }

        .app-subtitle {
            margin-top: var(--spacing-sm);
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .department-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            width: 100%;
            max-width: 340px;
        }

        .department-btn {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .department-btn:hover {
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .department-btn:active {
            transform: translateY(0);
        }

        .settings-link {
            margin-top: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            transition: color var(--transition-fast);
        }

        .settings-link:hover {
            color: var(--color-accent-primary);
        }

        /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            margin-bottom: var(--spacing-md);
        }

        .back-btn,
        .stats-btn,
        .header-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            font-size: 1.1rem;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .back-btn:hover,
        .stats-btn:hover,
        .header-btn:hover {
            border-color: var(--color-accent-primary);
        }

        .header-spacer {
            width: 40px;
        }

        .department-name {
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            color: var(--color-text-primary);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            flex: 1;
            align-content: start;
        }

        .category-tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md);
            transition: all var(--transition-fast);
            min-height: 90px;
            box-shadow: var(--shadow-sm);
        }

        .category-tile:hover {
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .category-icon {
            font-size: 1.75rem;
        }

        .category-name {
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
            color: var(--color-text-secondary);
        }

        /* çµ±è¨ˆç”»é¢ */
        .analytics-tabs {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .tab-btn {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: all var(--transition-fast);
        }

        .tab-btn.active {
            background: var(--color-accent-gradient);
            color: white;
            border-color: transparent;
        }

        .analytics-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .log-list,
        .summary-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .log-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        .log-type {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: 700;
        }

        .log-type.in {
            background: rgba(22, 163, 74, 0.1);
            color: var(--color-in);
        }

        .log-type.out {
            background: rgba(220, 38, 38, 0.1);
            color: var(--color-out);
        }

        .log-details {
            flex: 1;
            min-width: 0;
        }

        .log-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .log-meta {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .log-quantity {
            font-size: 1rem;
            font-weight: 600;
        }

        .summary-item {
            padding: var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        .summary-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .summary-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .summary-item-total {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-accent-primary);
        }

        .summary-departments {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
        }

        .summary-dept {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: var(--color-bg-tertiary);
            border-radius: 4px;
            color: var(--color-text-secondary);
        }

        .budget-controls {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .budget-select {
            flex: 1;
            padding: var(--spacing-sm);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            color: var(--color-text-primary);
        }

        .budget-table-wrapper {
            flex: 1;
            overflow: auto;
            margin-bottom: var(--spacing-md);
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .budget-table th,
        .budget-table td {
            padding: var(--spacing-sm);
            text-align: center;
            border: 1px solid var(--color-border);
            white-space: nowrap;
        }

        .budget-table th {
            background: var(--color-bg-tertiary);
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .budget-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .budget-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--color-bg-card);
            font-weight: 500;
            text-align: left;
        }

        .export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            width: 100%;
            padding: var(--spacing-md);
            background: var(--color-accent-gradient);
            color: white;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            transition: opacity var(--transition-fast);
        }

        .export-btn:hover {
            opacity: 0.9;
        }

        /* è¨­å®šç”»é¢ */
        .settings-section {
            margin-bottom: var(--spacing-lg);
        }

        .settings-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .add-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--color-accent-primary);
            color: white;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        .settings-item-name {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .delete-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-danger);
            font-size: 1rem;
            border-radius: 50%;
            transition: background var(--transition-fast);
        }

        .delete-btn:hover {
            background: rgba(220, 38, 38, 0.1);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            position: relative;
            width: 100%;
            max-width: 420px;
            max-height: 85vh;
            background: var(--color-bg-card);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp var(--transition-normal);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg) var(--spacing-md) var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border-radius: 50%;
            font-size: 1rem;
            color: var(--color-text-secondary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        /* ç”¨å“ãƒªã‚¹ãƒˆ */
        .items-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .item-row:hover {
            background: var(--color-bg-tertiary);
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .item-expiry-info {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .item-expiry-info.has-expired {
            color: var(--color-danger);
        }

        .item-stock {
            font-size: 1rem;
            font-weight: 600;
            margin-left: var(--spacing-md);
            color: var(--color-accent-primary);
        }

        /* å…¥å‡ºåº«ãƒ•ã‚©ãƒ¼ãƒ  */
        .current-stock {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-md);
        }

        .stock-label {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        .stock-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0 var(--spacing-sm);
            color: var(--color-accent-primary);
        }

        .transaction-type-toggle {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .type-btn {
            flex: 1;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            transition: all var(--transition-fast);
        }

        .type-btn[data-type="IN"].active {
            background: rgba(22, 163, 74, 0.1);
            border-color: var(--color-in);
            color: var(--color-in);
        }

        .type-btn[data-type="OUT"].active {
            background: rgba(220, 38, 38, 0.1);
            border-color: var(--color-out);
            color: var(--color-out);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            color: var(--color-text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-accent-primary);
        }

        .quantity-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .quantity-input input {
            flex: 1;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border-radius: var(--border-radius-sm);
            font-size: 1.25rem;
            transition: background var(--transition-fast);
        }

        .qty-btn:hover {
            background: var(--color-bg-secondary);
        }

        /* æœŸé™ãƒ­ãƒƒãƒˆé¸æŠ */
        .lot-select-group {
            margin-bottom: var(--spacing-md);
        }

        .lot-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            max-height: 150px;
            overflow-y: auto;
        }

        .lot-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .lot-item:hover {
            background: var(--color-bg-tertiary);
        }

        .lot-item.selected {
            border-color: var(--color-accent-primary);
            background: rgba(217, 119, 6, 0.1);
        }

        .lot-item.expired {
            color: var(--color-danger);
        }

        .lot-expiry {
            font-size: 0.85rem;
        }

        .lot-qty {
            font-weight: 600;
        }

        .save-btn {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--color-accent-gradient);
            color: white;
            border-radius: var(--border-radius-sm);
            font-size: 0.95rem;
            font-weight: 600;
            margin-top: var(--spacing-md);
            transition: opacity var(--transition-fast);
        }

        .save-btn:hover {
            opacity: 0.9;
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            color: var(--color-text-muted);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        @media (min-width: 768px) {
            .screen {
                max-width: 420px;
                margin: 0 auto;
            }

            .modal-content {
                border-radius: var(--border-radius-xl);
                margin-bottom: var(--spacing-xl);
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- éƒ¨ç½²é¸æŠç”»é¢ -->
    <section id="department-select" class="screen active">
        <div class="screen-header">
            <h1 class="app-title"><span class="title-icon">ğŸš’</span>EMSåœ¨åº«ç®¡ç†</h1>
            <p class="app-subtitle">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        </div>
        <div class="department-grid" id="department-grid"></div>
        <button class="settings-link" id="open-settings">âš™ï¸ ã‚«ãƒ†ã‚´ãƒªãƒ»ç”¨å“è¨­å®š</button>
    </section>

    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <section id="dashboard" class="screen">
        <header class="dashboard-header">
            <button class="back-btn" id="back-to-home">â†</button>
            <h2 class="department-name" id="current-department-name">éƒ¨ç½²å</h2>
            <button class="stats-btn" id="open-stats">ğŸ“Š</button>
        </header>
        <div class="category-grid" id="category-grid"></div>
    </section>

    <!-- çµ±è¨ˆç”»é¢ -->
    <section id="analytics" class="screen">
        <header class="dashboard-header">
            <button class="back-btn" id="back-to-dashboard">â†</button>
            <h2 class="department-name">å…¨ä½“çµ±è¨ˆãƒ»åˆ†æ</h2>
            <div class="header-spacer"></div>
        </header>
        <div class="analytics-tabs">
            <button class="tab-btn active" data-tab="log">å±¥æ­´</button>
            <button class="tab-btn" data-tab="summary">åœ¨åº«</button>
            <button class="tab-btn" data-tab="budget">äºˆç®—</button>
        </div>
        <div class="analytics-content">
            <div id="tab-log" class="tab-content active">
                <div class="log-list" id="log-list"></div>
            </div>
            <div id="tab-summary" class="tab-content">
                <div class="summary-list" id="summary-list"></div>
            </div>
            <div id="tab-budget" class="tab-content">
                <div class="budget-controls">
                    <select id="budget-year" class="budget-select"></select>
                    <select id="budget-month" class="budget-select">
                        <option value="all">å…¨æœŸé–“</option>
                    </select>
                </div>
                <div class="budget-table-wrapper">
                    <table class="budget-table" id="budget-table"></table>
                </div>
                <button class="export-btn" id="export-csv">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </section>

    <!-- è¨­å®šç”»é¢ -->
    <section id="settings" class="screen">
        <header class="dashboard-header">
            <button class="back-btn" id="back-from-settings">â†</button>
            <h2 class="department-name">ã‚«ãƒ†ã‚´ãƒªãƒ»ç”¨å“è¨­å®š</h2>
            <div class="header-spacer"></div>
        </header>
        <div class="settings-section">
            <div class="settings-section-title">
                <span>ã‚«ãƒ†ã‚´ãƒª</span>
                <button class="add-btn" id="add-category-btn">+ è¿½åŠ </button>
            </div>
            <div class="settings-list" id="categories-list"></div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">
                <span>ç”¨å“</span>
                <button class="add-btn" id="add-item-btn">+ è¿½åŠ </button>
            </div>
            <div class="settings-list" id="items-settings-list"></div>
        </div>
    </section>

    <!-- ç”¨å“ä¸€è¦§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="items-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="items-modal-title">ã‚«ãƒ†ã‚´ãƒªå</h3>
                <button class="modal-close" id="close-items-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <ul class="items-list" id="items-list"></ul>
            </div>
        </div>
    </div>

    <!-- å…¥å‡ºåº«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="transaction-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="transaction-modal-title">ç”¨å“å</h3>
                <button class="modal-close" id="close-transaction-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="current-stock">
                    <span class="stock-label">ç¾åœ¨åº«åˆè¨ˆ:</span>
                    <span class="stock-value" id="current-stock-value">0</span>
                    <span class="stock-unit" id="current-stock-unit">å€‹</span>
                </div>
                <div class="transaction-type-toggle">
                    <button class="type-btn active" data-type="IN" id="btn-type-in">å…¥åº«</button>
                    <button class="type-btn" data-type="OUT" id="btn-type-out">å‡ºåº«</button>
                </div>
                <div class="lot-select-group" id="lot-select-group" style="display:none;">
                    <label>å‡ºåº«ã™ã‚‹ãƒ­ãƒƒãƒˆï¼ˆæœŸé™ï¼‰ã‚’é¸æŠ:</label>
                    <div class="lot-list" id="lot-list"></div>
                </div>
                <div class="form-group" id="expiry-input-group" style="display:none;">
                    <label for="transaction-expiry">ä½¿ç”¨æœŸé™</label>
                    <input type="date" id="transaction-expiry">
                </div>
                <div class="form-group">
                    <label for="transaction-quantity">æ•°é‡</label>
                    <div class="quantity-input">
                        <button class="qty-btn" id="qty-minus">âˆ’</button>
                        <input type="number" id="transaction-quantity" value="1" min="1">
                        <button class="qty-btn" id="qty-plus">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="transaction-remarks">å‚™è€ƒ</label>
                    <input type="text" id="transaction-remarks" list="remarks-suggestions" placeholder="å‚™è€ƒã‚’å…¥åŠ›...">
                    <datalist id="remarks-suggestions">
                        <option value="ä½¿ç”¨æœŸé™åˆ‡ã‚Œ">
                        <option value="å®šæœŸè£œå……">
                        <option value="æ•‘æ€¥æ´»å‹•ã§ä½¿ç”¨">
                        <option value="è¨“ç·´ã§ä½¿ç”¨">
                        <option value="ç ´æãƒ»æ±šæ">
                    </datalist>
                </div>
                <button class="save-btn" id="save-transaction">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ†ã‚´ãƒªè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="add-category-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </h3>
                <button class="modal-close" id="close-add-category-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-category-name">ã‚«ãƒ†ã‚´ãƒªå</label>
                    <input type="text" id="new-category-name" placeholder="ä¾‹: è¼¸æ¶²">
                </div>
                <div class="form-group">
                    <label for="new-category-icon">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰</label>
                    <input type="text" id="new-category-icon" placeholder="ä¾‹: ğŸ’‰" maxlength="4">
                </div>
                <button class="save-btn" id="save-new-category">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <!-- ç”¨å“è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="add-item-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç”¨å“è¿½åŠ </h3>
                <button class="modal-close" id="close-add-item-modal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-item-category">ã‚«ãƒ†ã‚´ãƒª</label>
                    <select id="new-item-category"></select>
                </div>
                <div class="form-group">
                    <label for="new-item-name">ç”¨å“å</label>
                    <input type="text" id="new-item-name" placeholder="ä¾‹: ç”Ÿç†é£Ÿå¡©æ°´ 500ml">
                </div>
                <div class="form-group">
                    <label for="new-item-unit">å˜ä½</label>
                    <input type="text" id="new-item-unit" placeholder="ä¾‹: æœ¬" value="å€‹">
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="new-item-has-expiry" checked> ä½¿ç”¨æœŸé™ã‚ã‚Š</label>
                </div>
                <button class="save-btn" id="save-new-item">è¿½åŠ </button>
            </div>
        </div>
    </div>

    <script>
        /* EMSåœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v2 - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆJS */

        let DEPARTMENTS = [], CATEGORIES = [], ITEMS = [];
        const state = {
            deptId: null, catId: null, itemId: null, txType: 'IN', stocks: [], transactions: [], selectedLot: null
        };
        const el = {};

        document.addEventListener('DOMContentLoaded', init);

        function init() {
            cacheElements();
            bindEvents();
            loadData();
        }

        function cacheElements() {
            el.loading = document.getElementById('loading');
            el.screens = {
                departmentSelect: document.getElementById('department-select'),
                dashboard: document.getElementById('dashboard'),
                analytics: document.getElementById('analytics'),
                settings: document.getElementById('settings')
            };
            el.deptGrid = document.getElementById('department-grid');
            el.catGrid = document.getElementById('category-grid');
            el.deptName = document.getElementById('current-department-name');
            el.modals = {
                items: document.getElementById('items-modal'),
                transaction: document.getElementById('transaction-modal'),
                addCategory: document.getElementById('add-category-modal'),
                addItem: document.getElementById('add-item-modal')
            };
            el.itemsList = document.getElementById('items-list');
            el.itemsModalTitle = document.getElementById('items-modal-title');
            el.txModalTitle = document.getElementById('transaction-modal-title');
            el.stockValue = document.getElementById('current-stock-value');
            el.stockUnit = document.getElementById('current-stock-unit');
            el.txQty = document.getElementById('transaction-quantity');
            el.txExpiry = document.getElementById('transaction-expiry');
            el.txRemarks = document.getElementById('transaction-remarks');
            el.expiryInputGroup = document.getElementById('expiry-input-group');
            el.lotSelectGroup = document.getElementById('lot-select-group');
            el.lotList = document.getElementById('lot-list');
            el.saveBtn = document.getElementById('save-transaction');
            el.logList = document.getElementById('log-list');
            el.summaryList = document.getElementById('summary-list');
            el.budgetTable = document.getElementById('budget-table');
            el.budgetYear = document.getElementById('budget-year');
            el.budgetMonth = document.getElementById('budget-month');
            el.catsList = document.getElementById('categories-list');
            el.itemsSettingsList = document.getElementById('items-settings-list');
        }

        function bindEvents() {
            document.getElementById('back-to-home').onclick = () => showScreen('departmentSelect');
            document.getElementById('open-stats').onclick = () => { showScreen('analytics'); renderAnalytics(); };
            document.getElementById('back-to-dashboard').onclick = () => showScreen('dashboard');
            document.getElementById('open-settings').onclick = () => { showScreen('settings'); renderSettings(); };
            document.getElementById('back-from-settings').onclick = () => showScreen('departmentSelect');
            document.getElementById('close-items-modal').onclick = () => closeModal('items');
            document.getElementById('close-transaction-modal').onclick = () => closeModal('transaction');
            document.getElementById('close-add-category-modal').onclick = () => closeModal('addCategory');
            document.getElementById('close-add-item-modal').onclick = () => closeModal('addItem');
            document.querySelectorAll('.modal-overlay').forEach(o => o.onclick = () => Object.keys(el.modals).forEach(k => closeModal(k)));
            document.getElementById('btn-type-in').onclick = () => setTxType('IN');
            document.getElementById('btn-type-out').onclick = () => setTxType('OUT');
            document.getElementById('qty-minus').onclick = () => adjQty(-1);
            document.getElementById('qty-plus').onclick = () => adjQty(1);
            document.getElementById('save-transaction').onclick = saveTx;
            document.querySelectorAll('.tab-btn').forEach(b => b.onclick = () => switchTab(b.dataset.tab));
            el.budgetYear.onchange = renderBudget;
            el.budgetMonth.onchange = renderBudget;
            document.getElementById('export-csv').onclick = exportCSV;
            document.getElementById('add-category-btn').onclick = () => openModal('addCategory');
            document.getElementById('add-item-btn').onclick = () => { populateCatSelect(); openModal('addItem'); };
            document.getElementById('save-new-category').onclick = saveNewCategory;
            document.getElementById('save-new-item').onclick = saveNewItem;
        }

        function loadData() {
            showLoading(true);
            google.script.run.withSuccessHandler(d => {
                DEPARTMENTS = d.departments;
                CATEGORIES = d.categories;
                ITEMS = d.items;
                renderDeptGrid();
                loadStocks();
            }).withFailureHandler(handleError).getMasterData();
        }

        function loadStocks() {
            google.script.run.withSuccessHandler(s => { state.stocks = s; showLoading(false); }).withFailureHandler(handleError).getStocks();
        }

        function loadTx() {
            google.script.run.withSuccessHandler(t => { state.transactions = t; renderLog(); }).withFailureHandler(handleError).getTransactions(100);
        }

        function showScreen(n) { Object.values(el.screens).forEach(s => s.classList.remove('active')); el.screens[n].classList.add('active'); }
        function openModal(n) { el.modals[n].classList.add('active'); }
        function closeModal(n) { el.modals[n].classList.remove('active'); }
        function showLoading(s) { el.loading.classList.toggle('hidden', !s); }

        function renderDeptGrid() {
            el.deptGrid.innerHTML = DEPARTMENTS.map(d => `<button class="department-btn" data-id="${d.id}">${d.name}</button>`).join('');
            el.deptGrid.querySelectorAll('.department-btn').forEach(b => b.onclick = () => { state.deptId = +b.dataset.id; showDashboard(); });
        }

        function showDashboard() {
            const d = DEPARTMENTS.find(x => x.id === state.deptId);
            el.deptName.textContent = d.name + ' åœ¨åº«ç®¡ç†';
            renderCatGrid();
            showScreen('dashboard');
        }

        function renderCatGrid() {
            if (CATEGORIES.length === 0) {
                el.catGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><p>ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“<br>è¨­å®šã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p></div>';
                return;
            }
            el.catGrid.innerHTML = CATEGORIES.map(c => `<button class="category-tile" data-id="${c.id}"><span class="category-icon">${c.icon}</span><span class="category-name">${c.name}</span></button>`).join('');
            el.catGrid.querySelectorAll('.category-tile').forEach(t => t.onclick = () => { state.catId = +t.dataset.id; showItemsModal(); });
        }

        function showItemsModal() {
            const c = CATEGORIES.find(x => x.id === state.catId);
            el.itemsModalTitle.textContent = c.name;
            const items = ITEMS.filter(i => i.categoryId === state.catId);
            if (items.length === 0) {
                el.itemsList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><p>ç”¨å“ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
            } else {
                el.itemsList.innerHTML = items.map(item => {
                    const lots = getLots(state.deptId, item.id);
                    const total = lots.reduce((a, l) => a + l.quantity, 0);
                    const hasExpired = lots.some(l => getExpStatus(l.expiryDate) === 'expired');
                    const lotInfo = item.hasExpiry ? `${lots.length}ãƒ­ãƒƒãƒˆ` : '';
                    return `<li class="item-row" data-id="${item.id}">
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-expiry-info ${hasExpired ? 'has-expired' : ''}">${lotInfo}${hasExpired ? ' (æœŸé™åˆ‡ã‚Œã‚ã‚Š)' : ''}</div>
                </div>
                <div class="item-stock">${total}${item.unit}</div>
            </li>`;
                }).join('');
                el.itemsList.querySelectorAll('.item-row').forEach(r => r.onclick = () => { state.itemId = +r.dataset.id; showTxModal(); });
            }
            openModal('items');
        }

        function showTxModal() {
            const item = ITEMS.find(i => i.id === state.itemId);
            const lots = getLots(state.deptId, state.itemId);
            const total = lots.reduce((a, l) => a + l.quantity, 0);
            el.txModalTitle.textContent = item.name;
            el.stockValue.textContent = total;
            el.stockUnit.textContent = item.unit;
            el.txQty.value = 1;
            el.txRemarks.value = '';
            state.selectedLot = null;
            setTxType('IN');
            closeModal('items');
            openModal('transaction');
        }

        function setTxType(t) {
            state.txType = t;
            document.getElementById('btn-type-in').classList.toggle('active', t === 'IN');
            document.getElementById('btn-type-out').classList.toggle('active', t === 'OUT');
            const item = ITEMS.find(i => i.id === state.itemId);
            const lots = getLots(state.deptId, state.itemId);
            if (t === 'IN' && item.hasExpiry) {
                el.expiryInputGroup.style.display = 'block';
                el.lotSelectGroup.style.display = 'none';
                const def = new Date(); def.setFullYear(def.getFullYear() + 1);
                el.txExpiry.value = def.toISOString().split('T')[0];
            } else if (t === 'OUT' && item.hasExpiry && lots.length > 0) {
                el.expiryInputGroup.style.display = 'none';
                el.lotSelectGroup.style.display = 'block';
                renderLotList(lots);
            } else {
                el.expiryInputGroup.style.display = 'none';
                el.lotSelectGroup.style.display = 'none';
            }
        }

        function renderLotList(lots) {
            lots.sort((a, b) => new Date(a.expiryDate || '9999') - new Date(b.expiryDate || '9999'));
            el.lotList.innerHTML = lots.map((l, i) => {
                const exp = l.expiryDate || 'æœŸé™ãªã—';
                const status = getExpStatus(l.expiryDate);
                return `<div class="lot-item ${status === 'expired' ? 'expired' : ''}" data-idx="${i}">
            <span class="lot-expiry">${exp}</span>
            <span class="lot-qty">${l.quantity}å€‹</span>
        </div>`;
            }).join('');
            state.selectedLot = null;
            el.lotList.querySelectorAll('.lot-item').forEach(li => li.onclick = () => {
                el.lotList.querySelectorAll('.lot-item').forEach(x => x.classList.remove('selected'));
                li.classList.add('selected');
                state.selectedLot = lots[+li.dataset.idx];
            });
        }

        function adjQty(d) { const v = +el.txQty.value + d; if (v >= 1) el.txQty.value = v; }

        function saveTx() {
            const qty = +el.txQty.value;
            const remarks = el.txRemarks.value.trim();
            const item = ITEMS.find(i => i.id === state.itemId);
            if (isNaN(qty) || qty < 1) { alert('æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            let expiry = null;
            if (state.txType === 'IN' && item.hasExpiry) {
                expiry = el.txExpiry.value || null;
            } else if (state.txType === 'OUT' && item.hasExpiry) {
                if (!state.selectedLot) { alert('å‡ºåº«ã™ã‚‹ãƒ­ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
                if (state.selectedLot.quantity < qty) { alert('é¸æŠã—ãŸãƒ­ãƒƒãƒˆã®åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã¾ã™'); return; }
                expiry = state.selectedLot.expiryDate;
            }

            el.saveBtn.disabled = true;
            showLoading(true);

            const apiCall = state.txType === 'IN' ?
                google.script.run.withSuccessHandler(onTxSuccess).withFailureHandler(onTxError).stockIn(state.deptId, state.itemId, expiry, qty) :
                google.script.run.withSuccessHandler(onTxSuccess).withFailureHandler(onTxError).stockOut(state.deptId, state.itemId, expiry, qty);

            function onTxSuccess() {
                google.script.run.withSuccessHandler(() => {
                    loadStocks();
                    google.script.run.withSuccessHandler(tx => {
                        state.transactions.unshift(tx);
                        showLoading(false);
                        el.saveBtn.disabled = false;
                        closeModal('transaction');
                        showItemsModal();
                    }).addTransaction(state.deptId, state.itemId, state.txType, qty, expiry, remarks);
                }).getStocks().then ? null : setTimeout(() => { loadStocks(); }, 500);
            }
            function onTxError(e) { handleError(e); el.saveBtn.disabled = false; }
        }

        function renderAnalytics() { loadTx(); renderSummary(); initBudget(); renderBudget(); }
        function renderLog() {
            if (state.transactions.length === 0) { el.logList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><p>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div>'; return; }
            el.logList.innerHTML = state.transactions.slice(0, 50).map(tx => {
                const d = DEPARTMENTS.find(x => x.id === tx.departmentId);
                const i = ITEMS.find(x => x.id === tx.itemId);
                const cls = tx.type === 'IN' ? 'in' : 'out';
                return `<div class="log-item"><div class="log-type ${cls}">${tx.type === 'IN' ? 'å…¥åº«' : 'å‡ºåº«'}</div><div class="log-details"><div class="log-item-name">${i?.name || '?'}</div><div class="log-meta">${d?.name || '?'} / ${fmtDT(tx.timestamp)}${tx.expiryDate ? ' / æœŸé™:' + tx.expiryDate : ''}</div></div><div class="log-quantity">${tx.type === 'IN' ? '+' : '-'}${tx.quantity}</div></div>`;
            }).join('');
        }
        function renderSummary() {
            const sum = {};
            ITEMS.forEach(i => { sum[i.id] = { item: i, total: 0, depts: [] }; });
            state.stocks.forEach(s => { if (s.quantity > 0 && sum[s.itemId]) { const d = DEPARTMENTS.find(x => x.id === s.departmentId); sum[s.itemId].total += s.quantity; const existing = sum[s.itemId].depts.find(x => x.name === d?.name); if (existing) existing.qty += s.quantity; else sum[s.itemId].depts.push({ name: d?.name || '?', qty: s.quantity }); } });
            const active = Object.values(sum).filter(s => s.total > 0);
            if (active.length === 0) { el.summaryList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“¦</div><p>åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“</p></div>'; return; }
            el.summaryList.innerHTML = active.map(s => `<div class="summary-item"><div class="summary-item-header"><span class="summary-item-name">${s.item.name}</span><span class="summary-item-total">${s.total}${s.item.unit}</span></div><div class="summary-departments">${s.depts.map(d => `<span class="summary-dept">${d.name}: ${d.qty}</span>`).join('')}</div></div>`).join('');
        }
        function initBudget() {
            const yrs = new Set(); state.transactions.forEach(t => yrs.add(new Date(t.timestamp).getFullYear())); yrs.add(new Date().getFullYear());
            el.budgetYear.innerHTML = [...yrs].sort((a, b) => b - a).map(y => `<option value="${y}">${y}å¹´</option>`).join('');
            el.budgetMonth.innerHTML = '<option value="all">å…¨æœŸé–“</option>' + [...Array(12)].map((_, i) => `<option value="${i + 1}">${i + 1}æœˆ</option>`).join('');
        }
        function renderBudget() {
            const yr = +el.budgetYear.value, mo = el.budgetMonth.value;
            const flt = state.transactions.filter(t => t.type === 'OUT' && new Date(t.timestamp).getFullYear() === yr && (mo === 'all' || new Date(t.timestamp).getMonth() + 1 === +mo));
            const mx = {}; DEPARTMENTS.forEach(d => { mx[d.id] = {}; ITEMS.forEach(i => { mx[d.id][i.id] = 0; }); });
            flt.forEach(t => { if (mx[t.departmentId]) mx[t.departmentId][t.itemId] = (mx[t.departmentId][t.itemId] || 0) + t.quantity; });
            const used = ITEMS.filter(i => flt.some(t => t.itemId === i.id));
            if (used.length === 0) { el.budgetTable.innerHTML = '<tr><td colspan="12" style="padding:2rem;text-align:center">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>'; return; }
            let h = '<thead><tr><th>ç”¨å“</th>' + DEPARTMENTS.map(d => `<th>${d.name}</th>`).join('') + '<th>è¨ˆ</th></tr></thead><tbody>';
            used.forEach(i => { h += `<tr><td>${i.name}</td>`; let rt = 0; DEPARTMENTS.forEach(d => { const q = mx[d.id][i.id] || 0; rt += q; h += `<td>${q || '-'}</td>`; }); h += `<td><b>${rt}</b></td></tr>`; });
            h += '</tbody>'; el.budgetTable.innerHTML = h;
        }
        function exportCSV() {
            const yr = el.budgetYear.value, mo = el.budgetMonth.value;
            const flt = state.transactions.filter(t => t.type === 'OUT' && new Date(t.timestamp).getFullYear() === +yr && (mo === 'all' || new Date(t.timestamp).getMonth() + 1 === +mo));
            const mx = {}; ITEMS.forEach(i => { mx[i.id] = {}; DEPARTMENTS.forEach(d => { mx[i.id][d.id] = 0; }); }); flt.forEach(t => { mx[t.itemId][t.departmentId] += t.quantity; });
            let csv = '\ufeffç”¨å“å,' + DEPARTMENTS.map(d => d.name).join(',') + ',åˆè¨ˆ\n';
            ITEMS.forEach(i => { const vs = DEPARTMENTS.map(d => mx[i.id][d.id]); const t = vs.reduce((a, b) => a + b, 0); if (t > 0) csv += `"${i.name}",${vs.join(',')},${t}\n`; });
            const b = new Blob([csv], { type: 'text/csv;charset=utf-8' }), u = URL.createObjectURL(b), a = document.createElement('a'); a.href = u; a.download = `EMSä½¿ç”¨é‡_${yr}å¹´${mo === 'all' ? '' : mo + 'æœˆ'}.csv`; a.click(); URL.revokeObjectURL(u);
        }
        function switchTab(id) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id)); document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + id)); }

        // è¨­å®š
        function renderSettings() {
            el.catsList.innerHTML = CATEGORIES.map(c => `<div class="settings-item"><span class="settings-item-name">${c.icon} ${c.name}</span><button class="delete-btn" data-id="${c.id}" data-type="cat">Ã—</button></div>`).join('') || '<p style="color:var(--color-text-muted);font-size:0.85rem;">ã‚«ãƒ†ã‚´ãƒªãŒã‚ã‚Šã¾ã›ã‚“</p>';
            el.itemsSettingsList.innerHTML = ITEMS.map(i => { const c = CATEGORIES.find(x => x.id === i.categoryId); return `<div class="settings-item"><span class="settings-item-name">${i.name} <small style="color:var(--color-text-muted)">(${c?.name || '?'})</small></span><button class="delete-btn" data-id="${i.id}" data-type="item">Ã—</button></div>`; }).join('') || '<p style="color:var(--color-text-muted);font-size:0.85rem;">ç”¨å“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            el.catsList.querySelectorAll('.delete-btn').forEach(b => b.onclick = () => deleteCategory(+b.dataset.id));
            el.itemsSettingsList.querySelectorAll('.delete-btn').forEach(b => b.onclick = () => deleteItemSetting(+b.dataset.id));
        }
        function populateCatSelect() {
            document.getElementById('new-item-category').innerHTML = CATEGORIES.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        function saveNewCategory() {
            const n = document.getElementById('new-category-name').value.trim();
            const ic = document.getElementById('new-category-icon').value.trim() || 'ğŸ“¦';
            if (!n) { alert('ã‚«ãƒ†ã‚´ãƒªåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            showLoading(true);
            google.script.run.withSuccessHandler(c => { CATEGORIES.push(c); showLoading(false); closeModal('addCategory'); renderSettings(); renderCatGrid(); document.getElementById('new-category-name').value = ''; }).withFailureHandler(handleError).addCategory(n, ic);
        }
        function saveNewItem() {
            const cid = +document.getElementById('new-item-category').value;
            const n = document.getElementById('new-item-name').value.trim();
            const u = document.getElementById('new-item-unit').value.trim() || 'å€‹';
            const he = document.getElementById('new-item-has-expiry').checked;
            if (!n) { alert('ç”¨å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            showLoading(true);
            google.script.run.withSuccessHandler(i => { ITEMS.push(i); showLoading(false); closeModal('addItem'); renderSettings(); document.getElementById('new-item-name').value = ''; }).withFailureHandler(handleError).addItem(cid, n, u, he);
        }
        function deleteCategory(id) {
            if (!confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªã¨æ‰€å±ã™ã‚‹ç”¨å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            showLoading(true);
            google.script.run.withSuccessHandler(() => { CATEGORIES = CATEGORIES.filter(c => c.id !== id); ITEMS = ITEMS.filter(i => i.categoryId !== id); showLoading(false); renderSettings(); renderCatGrid(); }).withFailureHandler(handleError).deleteCategory(id);
        }
        function deleteItemSetting(id) {
            if (!confirm('ã“ã®ç”¨å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            showLoading(true);
            google.script.run.withSuccessHandler(() => { ITEMS = ITEMS.filter(i => i.id !== id); showLoading(false); renderSettings(); }).withFailureHandler(handleError).deleteItem(id);
        }

        // ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function getLots(deptId, itemId) { return state.stocks.filter(s => s.departmentId === deptId && s.itemId === itemId && s.quantity > 0); }
        function getExpStatus(d) { if (!d) return 'none'; const t = new Date(); t.setHours(0, 0, 0, 0); const e = new Date(d); return Math.ceil((e - t) / 864e5) < 0 ? 'expired' : 'ok'; }
        function fmtDT(s) { const d = new Date(s); return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`; }
        function handleError(e) { showLoading(false); console.error(e); alert('ã‚¨ãƒ©ãƒ¼: ' + (e.message || e)); }
    </script>
</body>

</html>