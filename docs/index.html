<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊïëÊÄ•Áî®ÂìÅÂú®Â∫´ÁÆ°ÁêÜ</title>
    <meta name="description" content="Ê∂àÈò≤ÊïëÊÄ•Ë≥áÂô®Êùê„ÅÆÂú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg-primary: #faf9f7;
            --color-bg-secondary: #f5f4f0;
            --color-bg-tertiary: #e8e6e1;
            --color-bg-card: #ffffff;
            --color-text-primary: #1a1a1a;
            --color-text-secondary: #5c5c5c;
            --color-text-muted: #8c8c8c;
            --color-accent-primary: #d97706;
            --color-accent-secondary: #ea580c;
            --color-accent-gradient: linear-gradient(135deg, #d97706, #ea580c);
            --color-success: #16a34a;
            --color-danger: #dc2626;
            --color-in: #16a34a;
            --color-out: #dc2626;
            --color-border: rgba(0, 0, 0, 0.08);
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-xl: 24px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition-fast: 150ms ease;
            --font-family: 'Noto Sans JP', sans-serif;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            min-height: 100dvh;
            line-height: 1.5;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
            color: inherit;
            touch-action: manipulation;
            /* „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢ */
        }

        input,
        select {
            font-family: inherit;
            font-size: 1rem;
        }

        .screen {
            display: none;
            flex-direction: column;
            min-height: 100dvh;
            padding: var(--spacing-md);
            animation: fadeIn 0.2s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(250, 249, 247, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-bg-tertiary);
            border-top-color: var(--color-accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }



        #department-select {
            justify-content: center;
            align-items: center;
            gap: var(--spacing-xl);
        }

        .screen-header {
            text-align: center;
        }

        .app-title {
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            color: var(--color-accent-primary);
        }

        .app-subtitle {
            margin-top: var(--spacing-sm);
            color: var(--color-text-secondary);
            font-size: 0.9rem;
        }

        .department-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            width: 100%;
            max-width: 340px;
        }

        .department-btn {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .department-btn:hover {
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .settings-link {
            margin-top: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
        }

        .settings-link:hover {
            color: var(--color-accent-primary);
        }

        .top-links {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            margin-top: var(--spacing-lg);
        }

        .top-links .settings-link {
            margin-top: 0;
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) 0;
            margin-bottom: var(--spacing-md);
        }

        .back-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            font-size: 1.1rem;
            box-shadow: var(--shadow-sm);
        }

        .stats-btn {
            height: 40px;
            padding: 0 var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
            white-space: nowrap;
        }

        .header-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-sm);
            min-width: 50px;
        }

        .header-action-btn:hover {
            border-color: var(--color-accent-primary);
        }

        .header-action-btn .material-symbols-outlined {
            font-size: 1.1rem;
            color: var(--color-accent-primary);
        }

        .header-action-btn .action-label {
            font-size: 0.55rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            white-space: nowrap;
        }

        .back-btn:hover,
        .stats-btn:hover {
            border-color: var(--color-accent-primary);
        }

        .header-spacer {
            width: 40px;
        }

        .department-name {
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            flex: 1;
            align-content: start;
        }

        .category-tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-md);
            aspect-ratio: 1;
            box-shadow: var(--shadow-sm);
        }

        .category-tile.add-tile {
            border: 2px dashed var(--color-border);
            background: transparent;
            box-shadow: none;
        }

        .add-icon {
            font-size: 2rem;
            color: var(--color-text-muted);
        }

        .add-item-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg);
            border: 2px dashed var(--color-border);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            margin-top: var(--spacing-sm);
        }

        .add-item-icon {
            font-size: 1.5rem;
            color: var(--color-text-muted);
        }

        .add-item-text {
            color: var(--color-text-muted);
        }

        .transfer-checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
        }

        .transfer-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }

        #transfer-checkbox-text {
            font-weight: 500;
        }

        .category-tile:hover {
            border-color: var(--color-accent-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .category-icon {
            font-size: 1.75rem;
        }

        .category-name {
            font-size: 0.8rem;
            font-weight: 500;
            text-align: center;
            color: var(--color-text-secondary);
        }

        .analytics-tabs {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .tab-btn {
            flex: 1;
            padding: var(--spacing-sm);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-text-secondary);
        }

        .tab-btn.active {
            background: var(--color-accent-gradient);
            color: white;
            border-color: transparent;
        }

        .analytics-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .log-list,
        .summary-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .log-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        .log-type {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: 700;
        }

        .log-type.in {
            background: rgba(22, 163, 74, 0.1);
            color: var(--color-in);
        }

        .log-type.out {
            background: rgba(220, 38, 38, 0.1);
            color: var(--color-out);
        }

        .log-details {
            flex: 1;
            min-width: 0;
        }

        .log-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .log-meta {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .log-quantity {
            font-size: 1rem;
            font-weight: 600;
        }

        .summary-item {
            padding: var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        .summary-item.low-stock {
            background: #fff5f5;
            border-color: #e53e3e;
        }

        .summary-department {
            background: var(--color-bg-secondary);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .summary-dept-header {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-text-primary);
            padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--color-accent-primary);
        }

        .summary-category {
            background: var(--color-bg-card);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .summary-category-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--color-border);
        }

        .min-stock-label {
            font-size: 0.7rem;
            color: #e53e3e;
            background: #fff5f5;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        .summary-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .summary-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .summary-item-total {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-accent-primary);
        }

        .summary-departments {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
        }

        .summary-dept {
            font-size: 0.7rem;
            padding: 2px 6px;
            background: var(--color-bg-tertiary);
            border-radius: 4px;
            color: var(--color-text-secondary);
        }

        .budget-controls {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .budget-select {
            flex: 1;
            padding: var(--spacing-sm);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            color: var(--color-text-primary);
        }

        .budget-table-wrapper {
            flex: 1;
            overflow: auto;
            margin-bottom: var(--spacing-md);
        }

        .budget-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .budget-table th,
        .budget-table td {
            padding: var(--spacing-sm);
            text-align: center;
            border: 1px solid var(--color-border);
            white-space: nowrap;
        }

        .budget-table th {
            background: var(--color-bg-tertiary);
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        .budget-table td:first-child {
            position: sticky;
            left: 0;
            background: var(--color-bg-card);
            font-weight: 500;
            text-align: left;
        }

        .export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            width: 100%;
            padding: var(--spacing-md);
            background: var(--color-accent-gradient);
            color: white;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .settings-section {
            margin-bottom: var(--spacing-lg);
        }

        .settings-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .add-btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--color-accent-primary);
            color: white;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        .settings-item-name {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .delete-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-danger);
            font-size: 1rem;
            border-radius: 50%;
        }

        .delete-btn:hover {
            background: rgba(220, 38, 38, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
        }

        .modal-content {
            position: relative;
            width: 100%;
            max-width: 420px;
            max-height: 85vh;
            background: var(--color-bg-card);
            border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.25s ease;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-lg) var(--spacing-md) var(--spacing-md);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border-radius: 50%;
            font-size: 1rem;
            color: var(--color-text-secondary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .items-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .item-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
        }

        .item-row:hover {
            background: var(--color-bg-tertiary);
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .item-expiry-info {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-top: 2px;
        }

        .item-expiry-info.has-expired {
            color: var(--color-danger);
        }

        .item-stock {
            font-size: 1rem;
            font-weight: 600;
            margin-left: var(--spacing-md);
            color: var(--color-accent-primary);
        }

        .current-stock {
            text-align: center;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-md);
        }

        .stock-label {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
        }

        .stock-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0 var(--spacing-sm);
            color: var(--color-accent-primary);
        }

        .transaction-type-toggle {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .type-btn {
            flex: 1;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
        }

        .type-btn[data-type="IN"].active {
            background: rgba(22, 163, 74, 0.1);
            border-color: var(--color-in);
            color: var(--color-in);
        }

        .type-btn[data-type="OUT"].active {
            background: rgba(220, 38, 38, 0.1);
            border-color: var(--color-out);
            color: var(--color-out);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            color: var(--color-text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-accent-primary);
        }

        .quantity-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .quantity-input input {
            flex: 1;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border-radius: var(--border-radius-sm);
            font-size: 1.25rem;
        }

        .lot-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
            max-height: 150px;
            overflow-y: auto;
        }

        .lot-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-secondary);
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
        }

        .lot-item.selected {
            border-color: var(--color-accent-primary);
            background: rgba(217, 119, 6, 0.1);
        }

        .lot-item.expired {
            color: var(--color-danger);
        }

        .save-btn {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--color-accent-gradient);
            color: white;
            border-radius: var(--border-radius-sm);
            font-size: 0.95rem;
            font-weight: 600;
            margin-top: var(--spacing-md);
        }

        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xl);
            color: var(--color-text-muted);
            text-align: center;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: middle;
        }

        .category-icon .material-symbols-outlined {
            font-size: 2.5rem;
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .api-config {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        .api-config label {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }

        .api-config input {
            width: 100%;
            margin-top: var(--spacing-xs);
            font-size: 0.8rem;
        }

        .icon-selection-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--spacing-xs);
            margin-top: var(--spacing-xs);
        }

        .icon-option {
            font-size: 1.5rem;
            text-align: center;
            padding: var(--spacing-xs);
            border: 2px solid transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            background: var(--color-bg-secondary);
            transition: all 0.2s;
        }

        .icon-option:hover {
            background: var(--color-bg-card);
        }

        .icon-option.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }



        /* „Éà„Ç∞„É´„Çπ„Ç§„ÉÉ„ÉÅ */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-md);
        }

        .toggle-label {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked+.toggle-slider {
            background: var(--color-accent-gradient);
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(22px);
        }

        /* „Ç´„ÉÜ„Ç¥„É™ËøΩÂä†„Éú„Çø„É≥ÔºàË®≠ÂÆöÁîªÈù¢Ôºâ */
        .settings-add-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            background: var(--color-accent-gradient);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .settings-add-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        /* „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Éï„ÉÉ„Çø„Éº */
        .dashboard-footer {
            text-align: center;
            padding: var(--spacing-lg) 0;
            margin-top: auto;
        }

        .guide-link {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            color: var(--color-text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            transition: all 0.2s;
        }

        .guide-link:hover {
            color: var(--color-accent-primary);
            background: var(--color-bg-secondary);
        }

        /* -------------------------------------------
           Âú®Â∫´„Éû„Éà„É™„ÉÉ„ÇØ„ÇπË°®Á§∫ÔºàÊñ∞„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ
        ------------------------------------------- */
        .matrix-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: var(--spacing-md);
        }

        .matrix-accordion {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .matrix-accordion-item {
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            background: var(--color-bg-card);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .matrix-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--color-bg-secondary);
            cursor: pointer;
            user-select: none;
            transition: background var(--transition-fast);
        }

        .matrix-accordion-header:hover {
            background: var(--color-bg-tertiary);
        }

        .matrix-accordion-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .matrix-category-icon {
            font-size: 1.4rem;
        }

        .accordion-toggle-icon {
            transition: transform var(--transition-fast);
        }

        .matrix-accordion-item.open .accordion-toggle-icon {
            transform: rotate(180deg);
        }

        .matrix-accordion-content {
            display: none;
            padding: var(--spacing-sm);
            background: var(--color-bg-card);
            overflow-x: auto;
        }

        .matrix-accordion-item.open .matrix-accordion-content {
            display: block;
        }

        /* „Éû„Éà„É™„ÉÉ„ÇØ„Çπ„ÉÜ„Éº„Éñ„É´ */
        .inventory-matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            min-width: 600px;
        }

        .inventory-matrix-table th,
        .inventory-matrix-table td {
            border: 1px solid var(--color-border);
            padding: var(--spacing-xs);
            text-align: center;
            white-space: nowrap;
        }

        /* „Éò„ÉÉ„ÉÄ„ÉºË°å */
        .inventory-matrix-table thead th {
            background: var(--color-bg-tertiary);
            font-weight: 600;
            padding: var(--spacing-sm) var(--spacing-xs);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* ÁΩ≤ÊâÄÂêç„Éò„ÉÉ„ÉÄ„Éº */
        .dept-header-cell {
            writing-mode: horizontal-tb;
            /* ÁΩ≤ÊâÄÂêç„ÅØÊ®™Êõ∏„Åç */
            min-width: 50px;
        }

        /* Â∑¶Á´Ø„ÅÆÂàóÔºàÁî®ÂìÅÂêçÔºâ„ÇíÂõ∫ÂÆö */
        .inventory-matrix-table tbody td:first-child,
        .inventory-matrix-table thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background: var(--color-bg-secondary);
            font-weight: 500;
            text-align: left;
            min-width: 140px;
            /* Áî®ÂìÅÂêçÂàó„ÅÆÂπÖÁ¢∫‰øù */
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-left: var(--spacing-sm);
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
        }

        /* Âàó„Éò„ÉÉ„ÉÄ„Éº„ÅÆÂ∑¶Á´ØÔºà„Ç≥„Éº„Éä„ÉºÔºâ */
        .inventory-matrix-table thead th:first-child {
            z-index: 30;
            /* ÊúÄÂâçÈù¢ */
            background: var(--color-bg-tertiary);
            text-align: center;
        }

        /* ÁΩ≤ÊâÄË®àÂàó„ÅÆ„Éè„Ç§„É©„Ç§„Éà */
        .total-col {
            background: #e0f2fe;
            /* ËñÑ„ÅÑÈùí */
            font-weight: 700;
        }

        .total-col-header {
            background: #bae6fd !important;
            /* Èùí */
        }

        /* Ë≠¶Èò≤Ë™≤Âàó„ÅÆ„Éè„Ç§„É©„Ç§„Éà */
        .keibouka-col {
            background: #fffbeb;
            /* ËñÑ„ÅÑÈªÑËâ≤ */
        }

        .keibouka-col-header {
            background: #fde68a !important;
            /* ÈªÑËâ≤ */
        }

        .matrix-table-wrapper {
            max-height: 600px;
            /* Á∏¶„Çπ„ÇØ„É≠„Éº„É´Áî® */
            overflow: auto;
        }

        /* Ê§úÁ¥¢„Éê„Éº */
        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .search-toggle {
            font-size: 1.2rem;
            color: var(--color-text-secondary);
            padding: var(--spacing-xs);
        }

        .search-bar {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-card);
            border-bottom: 1px solid var(--color-border);
        }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            background: var(--color-bg-secondary);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            gap: var(--spacing-sm);
        }

        .search-icon {
            color: var(--color-text-muted);
            font-size: 1.2rem;
        }

        .search-input-wrapper input {
            flex: 1;
            border: none;
            background: none;
            font-size: 1rem;
            color: var(--color-text-primary);
            outline: none;
        }

        .search-input-wrapper input::placeholder {
            color: var(--color-text-muted);
        }

        .search-clear {
            font-size: 1.2rem;
            color: var(--color-text-muted);
            padding: 4px;
            display: none;
        }

        .search-clear.visible {
            display: block;
        }

        .search-suggestions {
            margin-top: var(--spacing-sm);
            max-height: 300px;
            overflow-y: auto;
        }

        .suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-card);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-xs);
            cursor: pointer;
            transition: background 0.15s;
        }

        .suggestion-item:hover {
            background: var(--color-bg-secondary);
        }

        .suggestion-item-name {
            font-weight: 500;
        }

        .suggestion-item-category {
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }

        .suggestion-item-stock {
            font-size: 0.9rem;
            color: var(--color-accent-primary);
            font-weight: 600;
        }

        .matrix-detail-row td {
            font-size: 0.75rem;
            color: var(--color-text-secondary);
            background: #faf9f7;
            border-top: 1px dotted var(--color-border);
        }

        .matrix-detail-label {
            text-align: right !important;
            padding-right: var(--spacing-md) !important;
            font-weight: 500;
            color: var(--color-text-muted);
        }

        .lot-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
        }

        .lot-tag {
            font-size: 0.75rem;
            background: #e0f2f1;
            padding: 2px 6px;
            border-radius: 4px;
            color: #00695c;
        }

        .lot-tag.expired {
            background: #ffebee;
            color: #c62828;
        }

        .lot-breakdown {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-top: 4px;
            font-size: 0.65rem;
            color: var(--color-text-secondary);
        }

        .lot-item-matrix {
            background: rgba(0, 0, 0, 0.03);
            padding: 1px 3px;
            border-radius: 2px;
            white-space: nowrap;
        }

        .lot-item-matrix.expired-lot {
            color: var(--color-danger);
            background: #ffebee;
        }

        /* Âú®Â∫´‰∏çË∂≥„Ç¢„É©„Éº„ÉàÔºàËõç„ÅÆ„Çà„ÅÜ„Å™Áô∫ÂÖâÔºâ */
        @keyframes glow-red {
            0% {
                box-shadow: 0 0 5px rgba(239, 68, 68, 0.2);
                border-color: rgba(239, 68, 68, 0.4);
                background-color: rgba(254, 242, 242, 0.5);
            }

            50% {
                box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
                border-color: rgba(239, 68, 68, 1);
                background-color: rgba(254, 226, 226, 0.8);
            }

            100% {
                box-shadow: 0 0 5px rgba(239, 68, 68, 0.2);
                border-color: rgba(239, 68, 68, 0.4);
                background-color: rgba(254, 242, 242, 0.5);
            }
        }

        /* .alert-badge „ÅØÂªÉÊ≠¢„Åï„Çå„Åæ„Åó„Åü„Åå„ÄÅ„Ç≠„É£„ÉÉ„Ç∑„É•ÂØæÁ≠ñ„ÅßÂº∑Âà∂ÈùûË°®Á§∫ */
        .alert-badge {
            display: none !important;
        }

        /* ÊúüÈôê„Ç¢„É©„Éº„Éà„ÅÆÁô∫ÂÖâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        /* ÊúüÈôê„ÉªÂú®Â∫´„Ç¢„É©„Éº„Éà„ÅÆÁô∫ÂÖâ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .item-alert-label {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 4px;
            animation: glow-red 1.5s infinite alternate;
            font-weight: bold;
            color: #c62828;
            border: 1px solid rgba(239, 68, 68, 0.4);
            font-size: 0.85rem;
            background-color: #fff5f5;
        }

        /* item-row„Å´relative„ÇíËøΩÂä†„Åó„Å¶„Éê„ÉÉ„Ç∏„ÅÆÂü∫Ê∫ñ‰ΩçÁΩÆ„Å´„Åô„Çã */
        .item-row {
            position: relative;
            /* Êó¢Â≠ò„Çπ„Çø„Ç§„É´„ÅØJSÁîüÊàêÂÅ¥„ÅßclassÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß‰∏äÊõ∏„ÅçËøΩÂä† */
        }

        /* Âú®Â∫´‰∏çË∂≥„É™„Çπ„ÉàÔºà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÔºâ */
        .shortage-list-section {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: var(--border-radius-md);
        }

        .shortage-list-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: #c53030;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
        }

        .shortage-items {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .shortage-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
        }

        .shortage-item-row:hover {
            background: rgba(255, 255, 255, 1);
            cursor: pointer;
        }

        /* PCÂêë„Åë„É¨„Çπ„Éù„É≥„Ç∑„ÉñË®≠ÂÆöÔºàÊú´Â∞æ„Å´ÈÖçÁΩÆ„Åó„Å¶ÂÑ™ÂÖàÈÅ©Áî®Ôºâ */
        @media (min-width: 768px) {
            .screen {
                max-width: 1200px;
                margin: 0 auto;
                padding: var(--spacing-lg);
            }

            .department-grid {
                max-width: 100%;
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: var(--spacing-md);
            }

            .category-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: var(--spacing-md);
            }

            .modal-content {
                max-width: 600px;
                border-radius: var(--border-radius-xl);
                max-height: 90vh;
                margin: auto;
                position: relative;
                box-shadow: 0 4px 32px rgba(0, 0, 0, 0.2);
            }

            .modal {
                align-items: center;
                padding: var(--spacing-lg);
            }
        }
    </style>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <section id="department-select" class="screen active">
        <div class="screen-header">
            <h1 class="app-title">üöëÊïëÊÄ•Áî®ÂìÅÂú®Â∫´Ë°®</h1>
            <p class="app-subtitle">ÈÉ®ÁΩ≤„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
        </div>
        <div class="department-grid" id="department-grid"></div>
        <div class="top-links">
            <button class="settings-link" id="open-analytics-top">üìä Âú®Â∫´Áä∂Ê≥Å„Éª‰ΩøÁî®Â±•Ê≠¥</button>
            <button class="settings-link" id="open-settings">‚öôÔ∏è „Ç´„ÉÜ„Ç¥„É™„ÉªÁî®ÂìÅË®≠ÂÆö</button>
            <a href="manual.html" class="settings-link">üìñ ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</a>
        </div>
    </section>

    <section id="dashboard" class="screen">
        <header class="dashboard-header">
            <button class="back-btn" id="back-to-home">‚Üê</button>
            <h2 class="department-name" id="current-department-name">ÈÉ®ÁΩ≤Âêç</h2>
            <div class="header-actions">
                <!-- Ê§úÁ¥¢„Éê„ÉºÂ∏∏ÊôÇË°®Á§∫Âåñ„Å´‰º¥„ÅÑÂâäÈô§ -->
                <!-- <button class="icon-btn search-toggle" id="toggle-search">... -->

                <button class="header-action-btn" id="open-dept-inventory">
                    <span class="material-symbols-outlined">inventory</span>
                    <span class="action-label">Ëá™ÁΩ≤Âú®Â∫´</span>
                </button>
                <button class="header-action-btn" id="open-stats">
                    <span class="material-symbols-outlined">bar_chart</span>
                    <span class="action-label">ÂÖ®‰ΩìÂú®Â∫´</span>
                </button>
            </div>
        </header>
        <div class="search-bar" id="search-bar">
            <div class="search-input-wrapper">
                <span class="material-symbols-outlined search-icon">search</span>
                <input type="text" id="item-search" placeholder="Áî®ÂìÅÂêç„ÇíÊ§úÁ¥¢..." autocomplete="off">
                <button class="search-clear" id="search-clear">√ó</button>
            </div>
            <div class="search-suggestions" id="search-suggestions"></div>
        </div>
        <div class="category-grid" id="category-grid"></div>
        <div class="dashboard-footer">
            <a href="manual.html" class="guide-link">üìñ ‰Ωø„ÅÑÊñπ„Ç¨„Ç§„Éâ</a>
        </div>
    </section>

    <section id="analytics" class="screen">
        <header class="dashboard-header">
            <button class="back-btn" id="back-to-dashboard">‚Üê</button>
            <h2 class="department-name">ÂÖ®‰ΩìÁµ±Ë®à„ÉªÂàÜÊûê</h2>
            <div class="header-spacer"></div>
        </header>
        <div class="analytics-tabs">
            <button class="tab-btn active" data-tab="summary">Âú®Â∫´Áä∂Ê≥Å</button>
            <button class="tab-btn" data-tab="budget">‰ΩøÁî®ÂÆüÁ∏æ</button>
            <button class="tab-btn" data-tab="log">Â±•Ê≠¥</button>
        </div>
        <div class="analytics-content">
            <div id="tab-summary" class="tab-content active">
                <div class="summary-list" id="summary-list"></div>
            </div>
            <div id="tab-budget" class="tab-content">
                <div class="budget-controls">
                    <select id="budget-year" class="budget-select"></select>
                    <select id="budget-month" class="budget-select">
                        <option value="all">ÂÖ®ÊúüÈñì</option>
                    </select>
                </div>
                <div class="budget-table-wrapper">
                    <table class="budget-table" id="budget-table"></table>
                </div>
                <button class="export-btn" id="export-csv">üì• CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
            </div>
            <div id="tab-log" class="tab-content">
                <div class="log-list" id="log-list"></div>
            </div>
        </div>
    </section>

    <section id="settings" class="screen">
        <header class="dashboard-header">
            <button class="back-btn" id="back-to-home-from-settings">‚Üê</button>
            <h2 class="department-name">Ë®≠ÂÆö</h2>
            <div class="header-spacer"></div>
        </header>
        <div id="settings-container"></div>
    </section>

    <div class="modal" id="items-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="items-modal-title">„Ç´„ÉÜ„Ç¥„É™Âêç</h3><button class="modal-close" id="close-items-modal">√ó</button>
            </div>
            <div class="modal-body">
                <ul class="items-list" id="items-list"></ul>
            </div>
        </div>
    </div>

    <div class="modal" id="transaction-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="transaction-modal-title">Áî®ÂìÅÂêç</h3><button class="modal-close"
                    id="close-transaction-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="current-stock"><span class="stock-label">ÁèæÂú®Â∫´:</span><span class="stock-value"
                        id="current-stock-value">0</span><span id="current-stock-unit">ÂÄã</span></div>
                <div class="transaction-type-toggle">
                    <button class="type-btn" data-type="OUT" id="btn-type-out">Âá∫Â∫´</button>
                    <button class="type-btn active" data-type="IN" id="btn-type-in">ÂÖ•Â∫´</button>
                </div>
                <div class="form-group" id="lot-select-group" style="display:none;"><label>Âá∫Â∫´„É≠„ÉÉ„ÉàÈÅ∏Êäû:</label>
                    <div class="lot-list" id="lot-list"></div>
                </div>
                <div class="form-group" id="expiry-input-group" style="display:none;"><label
                        for="transaction-expiry">‰ΩøÁî®ÊúüÈôê</label><input type="date" id="transaction-expiry"></div>
                <div class="form-group"><label id="transaction-date-label">ÂÖ•Â∫´Êó•</label><input type="date"
                        id="transaction-date"></div>
                <div class="form-group"><label>Êï∞Èáè</label>
                    <div class="quantity-input"><button class="qty-btn" id="qty-minus">‚àí</button><input type="number"
                            id="transaction-quantity" value="1" min="1"><button class="qty-btn" id="qty-plus">+</button>
                    </div>
                </div>
                <div class="form-group"><label>ÂÇôËÄÉ</label><input type="text" id="transaction-remarks"
                        list="remarks-suggestions" placeholder="ÂÇôËÄÉ..."><datalist id="remarks-suggestions">
                        <option value="‰ΩøÁî®ÊúüÈôêÂàá„Çå">
                        <option value="ÂÆöÊúüË£úÂÖÖ">
                        <option value="ÊïëÊÄ•Ê¥ªÂãï„Åß‰ΩøÁî®">
                        <option value="Ë®ìÁ∑¥„Åß‰ΩøÁî®">
                        <option value="‰ªñÁΩ≤„Åã„ÇâÂèóÈ†ò">
                        <option value="‰ªñÁΩ≤„Å∏Ë≠≤Ê∏°">
                    </datalist></div>
                <div class="form-group" id="transfer-group" style="display:none;">
                    <label class="transfer-checkbox-label">
                        <input type="checkbox" id="is-transfer">
                        <span id="transfer-checkbox-text">ÁΩ≤ÊâÄÈñìÁßªÂãïÔºà‰ªñÁΩ≤„Åã„Çâ„ÇÇ„Çâ„ÅÜÔºâ</span>
                    </label>
                    <div id="transfer-dept-select" style="display:none;margin-top:8px;">
                        <label id="transfer-label">„Å©„Åì„Åã„ÇâÔºü</label>
                        <select id="transfer-dept"></select>
                    </div>
                </div>
                <button class="save-btn" id="save-transaction">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="modal" id="add-category-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="add-category-modal-title">„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†</h3><button class="modal-close"
                    id="close-add-category-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>„Ç´„ÉÜ„Ç¥„É™Âêç</label><input type="text" id="new-category-name"
                        placeholder="‰æã: Ëº∏Ê∂≤"></div>
                <div class="form-group"><label>„Ç¢„Ç§„Ç≥„É≥ÈÅ∏Êäû</label>
                    <div class="icon-selection-grid" id="new-category-icon-grid"></div>
                    <input type="hidden" id="new-category-icon">
                </div>
                <button class="save-btn" id="save-new-category">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="modal" id="add-item-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="add-item-modal-title">Áî®ÂìÅËøΩÂä†</h3><button class="modal-close" id="close-add-item-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label>„Ç´„ÉÜ„Ç¥„É™</label><select id="new-item-category"></select></div>
                <div class="form-group"><label>Áî®ÂìÅÂêç</label><input type="text" id="new-item-name"
                        placeholder="‰æã: ÁîüÁêÜÈ£üÂ°©Ê∞¥ 500ml"></div>
                <div class="form-group"><label>Âçò‰Ωç</label><input type="text" id="new-item-unit" placeholder="‰æã: Êú¨"
                        value="ÂÄã"></div>
                <div class="form-group toggle-group">
                    <label class="toggle-label">‰ΩøÁî®ÊúüÈôê„ÅÇ„Çä</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="new-item-has-expiry">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="form-group"><label>ÊúÄ‰ΩéÂú®Â∫´Êï∞ <small style="color:var(--color-text-muted)">(‰ªªÊÑè)</small></label>
                    <input type="number" id="new-item-min-stock" placeholder="0" min="0" value="0">
                </div>
                <button class="save-btn" id="save-new-item">ËøΩÂä†</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Supabase Ë®≠ÂÆö
        // ============================================
        const SUPABASE_URL = 'https://aacntdoacjjssspoctul.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhY250ZG9hY2pqc3NzcG9jdHVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MDA5OTcsImV4cCI6MjA4MzQ3Njk5N30.oBliHP_Jd9NOSSK1XFcO9egQWPzVhxn_KM0OTgaR8TQ';

        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const ICONS = [
            'medication', 'vaccines', 'medical_services', 'bloodtype',
            'sick', 'checkroom', 'clean_hands', 'healing',
            'sanitizer', 'inventory_2', 'monitor_heart', 'ambulance', 'edit_note', 'content_cut'
        ];
        const ICON_COLORS = {
            'medication': '#E91E63', 'vaccines': '#03A9F4', 'medical_services': '#3F51B5',
            'bloodtype': '#F44336', 'sick': '#4CAF50', 'checkroom': '#FF9800',
            'clean_hands': '#009688', 'healing': '#FFC107', 'sanitizer': '#00BCD4',
            'inventory_2': '#607D8B', 'monitor_heart': '#9C27B0', 'ambulance': '#FBC02D',
            'edit_note': '#795548', 'content_cut': '#607D8B'
        };
        // ÈÉ®ÁΩ≤„Éû„Çπ„Çø„ÉºÔºàÂõ∫ÂÆöÔºâ
        const DEPARTMENTS = [
            { id: 1, name: "Ë≠¶Èò≤Ë™≤" }, { id: 2, name: "‰∏âÊ¨°" }, { id: 3, name: "‰ΩúÊú®" },
            { id: 4, name: "ÂêâËàé" }, { id: 5, name: "‰∏âÂíå" }, { id: 6, name: "Âè£Âíå" },
            { id: 7, name: "Áî≤Â•¥" }, { id: 8, name: "Â∫ÑÂéü" }, { id: 9, name: "Ë•øÂüé" },
            { id: 10, name: "È´òÈáé" }, { id: 11, name: "Êù±Âüé" }
        ];
        let CATEGORIES = [], ITEMS = [];
        const state = { deptId: null, catId: null, itemId: null, txType: 'IN', stocks: [], transactions: [], selectedLot: null, editingCategoryId: null, editingItemId: null, settingsCatId: null };
        const $ = id => document.getElementById(id);
        const el = {};

        // Initialize Application
        function initializeApp() {
            cacheElements();
            bindEvents();
            loadData();
        }

        // Bootstrapping
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        function cacheElements() {
            el.loading = $('loading');
            if (!el.loading) el.loading = document.getElementById('loading');

            el.screens = {
                home: $('department-select'),
                dashboard: $('dashboard'),
                analytics: $('analytics'),
                settings: $('settings')
            };
            el.deptSelect = $('department-select');
            el.deptGrid = $('department-grid');
            el.deptName = $('current-department-name');
            el.categoryGrid = $('category-grid');
            el.catGrid = el.categoryGrid; // alias for renderCatGrid compatibility
            el.itemsModal = $('items-modal');
            el.itemsModalTitle = $('items-modal-title');
            el.itemsList = $('items-list');
            el.txModal = $('transaction-modal');
            el.txTitle = $('transaction-title');
            el.txDate = $('transaction-date');
            el.txDateLabel = $('transaction-date-label');
            el.txItemName = $('transaction-modal-title');
            el.txStock = $('current-stock-value');
            el.txQty = $('transaction-quantity');
            el.txExpiry = $('transaction-expiry');
            el.expiryInputGroup = $('expiry-input-group');
            el.lotSelectGroup = $('lot-select-group');
            el.lotList = $('lot-list');
            el.txRemarks = $('transaction-remarks');
            el.saveBtn = $('save-transaction');
            el.settingsContainer = $('settings-container');
            el.newCategoryIconGrid = $('new-category-icon-grid');
            el.newCategoryIconInput = $('new-category-icon');
            el.addCategoryModalTitle = $('add-category-modal-title');
            el.addItemModalTitle = $('add-item-modal-title');

            // Log & Summary & Budget elements
            el.logList = $('log-list');
            el.summaryList = $('summary-list');
            el.budgetTable = $('budget-table');
            el.budgetYear = $('budget-year');
            el.budgetMonth = $('budget-month');

            // „É¢„Éº„ÉÄ„É´„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•
            el.modals = {
                items: el.itemsModal,
                transaction: el.txModal,
                addCategory: $('add-category-modal'),
                addItem: $('add-item-modal')
            };

            // „Ç®„Ç§„É™„Ç¢„ÇπÔºàshowTxModal‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
            el.stockValue = el.txStock;
            el.stockUnit = $('current-stock-unit');
            el.txModalTitle = el.txItemName;
        }

        function bindEvents() {
            $('back-to-home').onclick = () => showScreen('home');
            $('open-dept-inventory').onclick = () => {
                showScreen('analytics');
                switchTab('summary');
                renderAnalytics();
            };
            $('open-stats').onclick = () => {
                state.deptId = null; // ÂÖ®‰ΩìÈõÜË®à
                showScreen('analytics');
                renderAnalytics();
            };
            $('open-analytics-top').onclick = () => {
                state.deptId = null; // ÂÖ®‰ΩìÈõÜË®à
                showScreen('analytics');
                renderAnalytics();
            };
            $('back-to-dashboard').onclick = () => {
                if (state.deptId) showScreen('dashboard');
                else showScreen('home');
            };
            $('open-settings').onclick = () => {
                showScreen('settings');
                renderSettings();
            };
            $('back-to-home-from-settings').onclick = () => showScreen('home');

            $('close-items-modal').onclick = () => el.itemsModal.classList.remove('active');
            $('close-transaction-modal').onclick = () => el.txModal.classList.remove('active');

            // „Ç´„ÉÜ„Ç¥„É™ËøΩÂä†„É¢„Éº„ÉÄ„É´
            $('close-add-category-modal').onclick = () => $('add-category-modal').classList.remove('active');
            $('save-new-category').onclick = saveNewCategory;

            // Áî®ÂìÅËøΩÂä†„É¢„Éº„ÉÄ„É´
            $('close-add-item-modal').onclick = () => $('add-item-modal').classList.remove('active');

            // Generic modal overlay close (for all modals)
            document.querySelectorAll('.modal-overlay').forEach(o => o.onclick = (e) => {
                // Find the parent modal and close it
                const modal = e.target.closest('.modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            });

            $('btn-type-in').onclick = () => setTxType('IN');
            $('btn-type-out').onclick = () => setTxType('OUT');

            $('qty-minus').onclick = () => { el.txQty.value = Math.max(1, (+el.txQty.value || 0) - 1); };
            $('qty-plus').onclick = () => { el.txQty.value = (+el.txQty.value || 0) + 1; };

            $('save-transaction').onclick = saveTx;

            document.querySelectorAll('.tab-btn').forEach(b => b.onclick = () => switchTab(b.dataset.tab));
            $('budget-year').onchange = renderBudget;
            $('budget-month').onchange = renderBudget;
            $('export-csv').onclick = exportCSV;

            $('save-new-item').onclick = saveNewItem;

            // Ê§úÁ¥¢Ê©üËÉΩ
            // $('toggle-search').onclick = toggleSearchBar; // Â∏∏ÊôÇË°®Á§∫„ÅÆ„Åü„ÇÅÂâäÈô§
            $('item-search').oninput = handleSearchInput;
            $('search-clear').onclick = clearSearch;
        }

        // ============================================
        // Supabase API
        // ============================================

        async function fsGetCategories() {
            const { data, error } = await db.from('categories').select('*').order('id');
            if (error) throw error;
            return data;
        }

        async function fsGetItems() {
            const { data, error } = await db.from('items').select('*').order('id');
            if (error) throw error;
            // „Ç´„É©„É†Âêç„Çí„Ç≠„É£„É°„É´„Ç±„Éº„Çπ„Å´Â§âÊèõ
            return data.map(r => ({
                id: +r.id, categoryId: +r.category_id, name: r.name, unit: r.unit,
                hasExpiry: r.has_expiry, minStock: +r.min_stock
            }));
        }

        async function fsGetStocks() {
            const { data, error } = await db.from('stocks').select('*');
            if (error) throw error;
            return data.map(r => ({
                departmentId: +r.department_id, itemId: +r.item_id,
                expiryDate: r.expiry_date, quantity: +r.quantity, id: r.id
            }));
        }

        async function fsGetTransactions(limit = 100) {
            const { data, error } = await db.from('transactions')
                .select('*').order('timestamp', { ascending: false }).limit(limit);
            if (error) throw error;
            return data.map(r => ({
                id: r.id, departmentId: +r.department_id, itemId: +r.item_id,
                type: r.type, quantity: +r.quantity, expiryDate: r.expiry_date,
                remarks: r.remarks, timestamp: r.timestamp
            }));
        }

        async function fsAddCategory(name, icon) {
            const { data, error } = await db.from('categories')
                .insert({ name, icon: icon || 'inventory_2' }).select().single();
            if (error) throw error;
            return data;
        }

        async function fsUpdateCategory(id, name, icon) {
            const { data, error } = await db.from('categories')
                .update({ name, icon: icon || 'inventory_2' }).eq('id', id).select().single();
            if (error) throw error;
            return data;
        }

        async function fsDeleteCategory(id) {
            // Èñ¢ÈÄ£Áî®ÂìÅ„ÅÆID„ÇíÂèñÂæó
            const { data: items } = await db.from('items').select('id').eq('category_id', id);
            const itemIds = items ? items.map(i => i.id) : [];

            // Èñ¢ÈÄ£„Åô„ÇãÂèñÂºïÂ±•Ê≠¥„ÇíÂâäÈô§
            if (itemIds.length > 0) {
                await db.from('transactions').delete().in('item_id', itemIds);
                await db.from('stocks').delete().in('item_id', itemIds);
            }

            // Èñ¢ÈÄ£Áî®ÂìÅ„ÇíÂâäÈô§
            await db.from('items').delete().eq('category_id', id);

            // „Ç´„ÉÜ„Ç¥„É™„ÇíÂâäÈô§
            const { error } = await db.from('categories').delete().eq('id', id);
            if (error) throw error;
            return { success: true };
        }

        async function fsAddItem(categoryId, name, unit, hasExpiry, minStock) {
            const { data, error } = await db.from('items')
                .insert({ category_id: categoryId, name, unit: unit || 'ÂÄã', has_expiry: !!hasExpiry, min_stock: minStock || 0 })
                .select().single();
            if (error) throw error;
            return { id: data.id, categoryId: data.category_id, name: data.name, unit: data.unit, hasExpiry: data.has_expiry, minStock: data.min_stock };
        }

        async function fsUpdateItem(id, categoryId, name, unit, hasExpiry, minStock) {
            const { data, error } = await db.from('items')
                .update({ category_id: categoryId, name, unit: unit || 'ÂÄã', has_expiry: !!hasExpiry, min_stock: minStock || 0 })
                .eq('id', id).select().single();
            if (error) throw error;
            return { id: data.id, categoryId: data.category_id, name: data.name, unit: data.unit, hasExpiry: data.has_expiry, minStock: data.min_stock };
        }

        async function fsDeleteItem(id) {
            // Èñ¢ÈÄ£„Åô„ÇãÂèñÂºïÂ±•Ê≠¥„Å®Âú®Â∫´„ÇíÂÖà„Å´ÂâäÈô§
            await db.from('transactions').delete().eq('item_id', id);
            await db.from('stocks').delete().eq('item_id', id);

            // Áî®ÂìÅ„ÇíÂâäÈô§
            const { error } = await db.from('items').delete().eq('id', id);
            if (error) throw error;
            return { success: true };
        }

        async function fsStockIn(deptId, itemId, expiryDate, quantity, remarks, transactionDate) {
            // Êó¢Â≠ò„ÅÆÂú®Â∫´„ÇíÊ§úÁ¥¢
            let query = db.from('stocks')
                .select('*')
                .eq('department_id', deptId)
                .eq('item_id', itemId);

            if (expiryDate) {
                query = query.eq('expiry_date', expiryDate);
            } else {
                query = query.is('expiry_date', null);
            }

            const { data: existing } = await query.limit(1).maybeSingle();

            if (existing) {
                await db.from('stocks')
                    .update({ quantity: existing.quantity + quantity })
                    .eq('id', existing.id);
            } else {
                await db.from('stocks')
                    .insert({ department_id: deptId, item_id: itemId, expiry_date: expiryDate || null, quantity });
            }
            return fsAddTransaction(deptId, itemId, 'IN', quantity, expiryDate, remarks, transactionDate);
        }

        async function fsStockOut(deptId, itemId, expiryDate, quantity, remarks, transactionDate) {
            let query = db.from('stocks')
                .select('*')
                .eq('department_id', deptId)
                .eq('item_id', itemId);

            if (expiryDate) {
                query = query.eq('expiry_date', expiryDate);
            } else {
                query = query.is('expiry_date', null);
            }

            const { data: existing, error } = await query.limit(1).maybeSingle();

            if (error || !existing || existing.quantity < quantity) {
                console.error('Âú®Â∫´‰∏çË∂≥„Ç®„É©„ÉºË©≥Á¥∞:', { deptId, itemId, expiryDate, quantity, existing, error });
                // „Éá„Éê„ÉÉ„Ç∞Áî®„Ç¢„É©„Éº„Éà„ÅØÂâäÈô§„Åó„ÄÅÊú¨Êù•„ÅÆ„Ç®„É©„Éº„ÅÆ„Åø„Çπ„É≠„Éº
                throw new Error('Âú®Â∫´‰∏çË∂≥');
            }

            const newQty = existing.quantity - quantity;
            if (newQty <= 0) {
                await db.from('stocks').delete().eq('id', existing.id);
            } else {
                await db.from('stocks').update({ quantity: newQty }).eq('id', existing.id);
            }
            return fsAddTransaction(deptId, itemId, 'OUT', quantity, expiryDate, remarks, transactionDate);
        }

        async function fsAddTransaction(deptId, itemId, type, quantity, expiryDate, remarks, transactionDate) {
            const ts = transactionDate ? new Date(transactionDate) : new Date();
            const { data, error } = await db.from('transactions')
                .insert({ department_id: deptId, item_id: itemId, type, quantity, expiry_date: expiryDate || null, remarks: remarks || '', timestamp: ts.toISOString() })
                .select().single();
            if (error) throw error;
            return { id: data.id, departmentId: +data.department_id, itemId: +data.item_id, type: data.type, quantity: +data.quantity, expiryDate: data.expiry_date, remarks: data.remarks, timestamp: data.timestamp };
        }

        async function fsUpdateStockExpiry(deptId, itemId, oldExpiry, newExpiry) {
            let query = db.from('stocks')
                .select('*')
                .eq('department_id', deptId)
                .eq('item_id', itemId);

            if (oldExpiry) {
                query = query.eq('expiry_date', oldExpiry);
            } else {
                query = query.is('expiry_date', null);
            }

            const { data: existing, error } = await query.limit(1).maybeSingle();

            if (error || !existing) {
                throw new Error('Ë©≤ÂΩì„Åô„ÇãÂú®Â∫´„É≠„ÉÉ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }

            await db.from('stocks').update({ expiry_date: newExpiry || null }).eq('id', existing.id);
            return { success: true };
        }

        const CACHE_KEY = 'ems_inventory_cache';

        async function loadData() {
            showLoading(true);

            // „Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâÂç≥Â∫ß„Å´Ë°®Á§∫
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                try {
                    const c = JSON.parse(cached);
                    CATEGORIES = c.categories || [];
                    ITEMS = c.items || [];
                    state.stocks = c.stocks || [];
                    state.transactions = c.transactions || [];
                    renderDeptGrid();
                    initBudget();
                } catch (e) {
                    console.warn('„Ç≠„É£„ÉÉ„Ç∑„É•Ë™≠ËæºÂ§±Êïó', e);
                }
            }

            // Supabase„Åã„ÇâÊúÄÊñ∞„Éá„Éº„Çø„ÇíÂèñÂæó
            try {
                // „Çø„Ç§„É†„Ç¢„Ç¶„Éà‰ªò„Åç„Åß„Éá„Éº„Çø„ÇíÂèñÂæó
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('„Çø„Ç§„É†„Ç¢„Ç¶„Éà: „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´ÊôÇÈñì„Åå„Åã„Åã„Å£„Å¶„ÅÑ„Åæ„Åô')), 10000));

                const dataPromise = Promise.all([
                    fsGetCategories(),
                    fsGetItems(),
                    fsGetStocks(),
                    fsGetTransactions(100)
                ]);

                [CATEGORIES, ITEMS, state.stocks, state.transactions] = await Promise.race([dataPromise, timeoutPromise]);

                // „Ç≠„É£„ÉÉ„Ç∑„É•Êõ¥Êñ∞
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    categories: CATEGORIES, items: ITEMS,
                    stocks: state.stocks, transactions: state.transactions,
                    timestamp: Date.now()
                }));

                renderDeptGrid();
                initBudget();
            } catch (e) {
                console.error('Data loading error:', e);
                if (!cached) {
                    handleError(e);
                    alert('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' + (e.message || e));
                }
            } finally {
                showLoading(false);
            }
        }

        function showScreen(n) { Object.values(el.screens).forEach(s => s.classList.remove('active')); el.screens[n].classList.add('active'); }
        function openModal(n) { el.modals[n].classList.add('active'); }
        function closeModal(n) { el.modals[n].classList.remove('active'); }
        function showLoading(s) { el.loading.classList.toggle('hidden', !s); }

        function renderDeptGrid() {
            el.deptGrid.innerHTML = DEPARTMENTS.map(d => `<button class="department-btn" data-id="${d.id}">${d.name}</button>`).join('');
            el.deptGrid.querySelectorAll('.department-btn').forEach(b => b.onclick = () => { state.deptId = +b.dataset.id; showDashboard(); });
        }

        function showDashboard() {
            const d = DEPARTMENTS.find(x => x.id === state.deptId);
            el.deptName.textContent = d.name + ' Âú®Â∫´ÁÆ°ÁêÜ';
            renderCatGrid();
            showScreen('dashboard');
            renderCatGrid();
            showScreen('dashboard');
            // Ê§úÁ¥¢„Éê„Éº„ÅØÂ∏∏ÊôÇË°®Á§∫„ÅÆ„Åü„ÇÅÈùûË°®Á§∫„É™„Çª„ÉÉ„Éà„Åó„Å™„ÅÑ
            // $('search-bar').style.display = 'none';
            $('item-search').value = '';
            $('search-suggestions').innerHTML = '';

            // Âú®Â∫´‰∏çË∂≥„É™„Çπ„Éà„ÅÆË°®Á§∫ÔºàËá™ÁΩ≤„ÅÆÂ†¥Âêà„ÅÆ„ÅøÔºâ
            const catGrid = $('category-grid');
            // Êó¢Â≠ò„ÅÆ„É™„Çπ„Éà„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
            const existingList = document.querySelector('.shortage-list-section');
            if (existingList) existingList.remove();

            if (state.deptId) {
                // Âú®Â∫´‰∏çË∂≥Êï∞Ââ≤„Çå
                const shortageItems = ITEMS.filter(item => {
                    const lots = getLots(state.deptId, item.id);
                    const total = lots.reduce((a, l) => a + l.quantity, 0);
                    return item.minStock > 0 && total < item.minStock;
                });

                // ÊúüÈôêÂàá„Çå„ÉªÊúüÈôêÈñìËøëÔºà60Êó•‰ª•ÂÜÖÔºâ
                const now = new Date();
                const threshold = new Date();
                threshold.setDate(threshold.getDate() + 60);

                const nearExpiryItems = ITEMS.filter(item => {
                    if (!item.hasExpiry) return false;
                    const lots = getLots(state.deptId, item.id);
                    if (lots.length === 0) return false;
                    // Âú®Â∫´‰∏çË∂≥„É™„Çπ„Éà„Å´Êó¢„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈáçË§áË°®Á§∫„Åó„Å™„ÅÑÔºü‚Üí„ÅÑ„ÇÑ„ÄÅÁêÜÁî±„ÅØÂà•„Å™„ÅÆ„ÅßË°®Á§∫„Åó„Å¶„ÇÇ„Çà„ÅÑ„Åå„ÄÅ‰ªäÂõû„ÅØÂàÜ„Åë„Çã
                    // ÊúüÈôê„Å´Èñ¢„Åô„ÇãË≠¶Âëä„Åå„ÅÇ„Çã„Åã
                    return lots.some(l => {
                        if (!l.expiryDate) return false;
                        const d = new Date(l.expiryDate);
                        return d < threshold;
                    });
                });

                // „É™„Çπ„Éà„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ‰ΩúÊàêÔºà„Ç¢„É©„Éº„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÇÇ„ÄåÁï∞Â∏∏„Å™„Åó„Äç„ÇíË°®Á§∫Ôºâ
                const section = document.createElement('div');
                section.className = 'shortage-list-section';
                let html = '';

                if (shortageItems.length > 0 || nearExpiryItems.length > 0) {
                    // „Ç¢„É©„Éº„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà

                    // 1. Âú®Â∫´‰∏çË∂≥„É™„Çπ„Éà
                    if (shortageItems.length > 0) {
                        html += `
                        <div class="shortage-list-header">
                            <span class="material-symbols-outlined">warning</span>
                            <span>Âú®Â∫´‰∏çË∂≥„ÅÆÁî®ÂìÅ„Åå„ÅÇ„Çä„Åæ„ÅôÔºàÂü∫Ê∫ñÊï∞Ââ≤„ÇåÔºâ</span>
                        </div>
                        <div class="shortage-items" style="margin-bottom: 1rem;">
                            ${shortageItems.map(item => {
                            const lots = getLots(state.deptId, item.id);
                            const total = lots.reduce((a, l) => a + l.quantity, 0);
                            return `<div class="shortage-item-row" onclick="state.catId=${item.categoryId};state.itemId=${item.id};showTxModal()">
                                    <span style="font-weight:500">${item.name}</span>
                                    <span style="color:var(--color-danger);font-weight:700">ÁèæÂú®: ${total}${item.unit} (Âü∫Ê∫ñ: ${item.minStock})</span>
                                </div>`;
                        }).join('')}
                        </div>`;
                    }

                    // 2. ÊúüÈôêÂàá„Çå„ÉªÈñìËøë„É™„Çπ„Éà
                    if (nearExpiryItems.length > 0) {
                        html += `
                        <div class="shortage-list-header" style="${shortageItems.length > 0 ? 'margin-top:0.5rem;border-top:1px dashed #fecaca;padding-top:0.5rem;' : ''}">
                            <span class="material-symbols-outlined">event_busy</span>
                            <span>ÊúüÈôêÂàá„Çå„ÉªÊúüÈôêÈñìËøë„ÅÆÁî®ÂìÅ„Åå„ÅÇ„Çä„Åæ„Åô</span>
                        </div>
                        <div class="shortage-items">
                            ${nearExpiryItems.map(item => {
                            const lots = getLots(state.deptId, item.id);
                            // „Éï„Ç£„É´„ÇøÊ∏à„Åø„Å†„ÅåÂøµ„ÅÆ„Åü„ÇÅÂÜçÂèñÂæó
                            const alertLots = lots.filter(l => {
                                if (!l.expiryDate) return false;
                                return new Date(l.expiryDate) < threshold;
                            }).sort((a, b) => (a.expiryDate || '').localeCompare(b.expiryDate || ''));

                            const lotText = alertLots.map(l => {
                                const isExp = getExpStatus(l.expiryDate) === 'expired';
                                return `<span style="${isExp ? 'color:red;font-weight:bold;' : ''}">${l.expiryDate}(${l.quantity})</span>`;
                            }).join(', ');

                            return `<div class="shortage-item-row" onclick="state.catId=${item.categoryId};state.itemId=${item.id};showTxModal()">
                                    <span style="font-weight:500">${item.name}</span>
                                    <span style="font-size:0.85rem; color:var(--color-text-secondary)">${lotText}</span>
                                </div>`;
                        }).join('')}
                        </div>`;
                    }
                } else {
                    // Áï∞Â∏∏„Å™„ÅóÔºàGoodÁä∂ÊÖãÔºâ
                    section.style.background = '#f0fff4'; // ËñÑ„ÅÑÁ∑ëËÉåÊôØ
                    section.style.borderColor = '#9ae6b4'; // Á∑ë„Éú„Éº„ÉÄ„Éº
                    html = `
                        <div class="shortage-list-header" style="color: #276749; margin-bottom: 0;">
                            <span class="material-symbols-outlined">check_circle</span>
                            <span>Âú®Â∫´Áä∂Ê≥Å„ÅØËâØÂ•Ω„Åß„ÅôÔºà‰∏çË∂≥„ÉªÊúüÈôêÂàá„ÇåÈñìËøë„Å™„ÅóÔºâ</span>
                        </div>`;
                }

                section.innerHTML = html;
                catGrid.insertAdjacentElement('afterend', section);
            }
        }

        // Ê§úÁ¥¢Ê©üËÉΩ
        // Ê§úÁ¥¢Ê©üËÉΩ
        // function toggleSearchBar() { ... } // Â∏∏ÊôÇË°®Á§∫„ÅÆ„Åü„ÇÅÂªÉÊ≠¢


        function handleSearchInput(e) {
            const query = e.target.value.trim().toLowerCase();
            const clearBtn = $('search-clear');
            clearBtn.classList.toggle('visible', query.length > 0);

            if (query.length === 0) {
                $('search-suggestions').innerHTML = '';
                return;
            }

            // Áî®ÂìÅ„ÇíÊ§úÁ¥¢
            const matches = ITEMS.filter(item =>
                item.name.toLowerCase().includes(query)
            ).slice(0, 10); // ÊúÄÂ§ß10‰ª∂

            renderSearchSuggestions(matches);
        }

        function renderSearchSuggestions(items) {
            const container = $('search-suggestions');
            if (items.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:var(--color-text-muted);padding:1rem;">Ë©≤ÂΩì„Åô„ÇãÁî®ÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
                return;
            }

            container.innerHTML = items.map(item => {
                const cat = CATEGORIES.find(c => c.id === item.categoryId);
                const catName = cat ? cat.name : '';
                const lots = getLots(state.deptId, item.id);
                const total = lots.reduce((a, l) => a + l.quantity, 0);
                return `<div class="suggestion-item" data-item-id="${item.id}" data-cat-id="${item.categoryId}">
                    <div>
                        <div class="suggestion-item-name">${item.name}</div>
                        <div class="suggestion-item-category">${catName}</div>
                    </div>
                    <div class="suggestion-item-stock">${total}${item.unit}</div>
                </div>`;
            }).join('');

            // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            container.querySelectorAll('.suggestion-item').forEach(el => {
                el.onclick = () => {
                    const itemId = +el.dataset.itemId;
                    const catId = +el.dataset.catId;
                    state.catId = catId;
                    state.itemId = itemId;
                    showTxModal();
                    clearSearch();
                };
            });
        }

        function clearSearch() {
            $('item-search').value = '';
            $('search-suggestions').innerHTML = '';
            $('search-clear').classList.remove('visible');
        }

        function renderCatGrid() {
            if (CATEGORIES.length === 0) {
                el.catGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><span class="material-symbols-outlined" style="font-size: 3rem;">inventory_2</span></div><p>„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div><button class="category-tile add-tile" onclick="openAddCategoryModal()"><span class="add-icon">+</span><span class="category-name">„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†</span></button>';
                return;
            }
            let html = CATEGORIES.map(c => `<button class="category-tile" data-id="${c.id}"><span class="category-icon"><span class="material-symbols-outlined" style="color: ${ICON_COLORS[c.icon] || ''}">${c.icon}</span></span><span class="category-name">${c.name}</span></button>`).join('');
            // ËøΩÂä†„Éú„Çø„É≥
            html += '<button class="category-tile add-tile" onclick="openAddCategoryModal()"><span class="add-icon">+</span><span class="category-name">ËøΩÂä†</span></button>';
            el.catGrid.innerHTML = html;
            el.catGrid.querySelectorAll('.category-tile:not(.add-tile)').forEach(t => t.onclick = () => { state.catId = +t.dataset.id; showItemsModal(); });
        }

        function showItemsModal() {
            const c = CATEGORIES.find(x => x.id === state.catId);
            el.itemsModalTitle.textContent = c.name;
            const items = ITEMS.filter(i => i.categoryId === state.catId);
            let html = '';
            if (items.length === 0) {
                html = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>Áî®ÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
            } else {
                html = items.map(item => {
                    const lots = getLots(state.deptId, item.id);
                    const total = lots.reduce((a, l) => a + l.quantity, 0);
                    const hasExpired = lots.some(l => getExpStatus(l.expiryDate) === 'expired');

                    let lotInfoHtml = '';
                    if (item.hasExpiry && lots.length > 0) {
                        const sortedLots = [...lots].sort((a, b) => (a.expiryDate || '9999').localeCompare(b.expiryDate || '9999'));
                        lotInfoHtml = `<div class="lot-tags">` +
                            sortedLots.map(l => {
                                const isExp = getExpStatus(l.expiryDate) === 'expired';
                                return `<span class="lot-tag ${isExp ? 'expired' : ''}">${l.expiryDate || 'ÊúüÈôê„Å™„Åó'}: ${l.quantity}</span>`;
                            }).join('') + `</div>`;
                    }

                    // Âú®Â∫´‰∏çË∂≥Âà§ÂÆö
                    const isShortage = item.minStock > 0 && total < item.minStock;

                    // ÊúüÈôêÂàá„Çå„ÉªÊúüÈôêÈñìËøëÂà§ÂÆöÔºà60Êó•‰ª•ÂÜÖÔºâ
                    let hasNearExpiry = false;
                    if (item.hasExpiry && lots.length > 0) {
                        const now = new Date();
                        const threshold = new Date();
                        threshold.setDate(threshold.getDate() + 60); // 60Êó•‰ª•ÂÜÖ

                        hasNearExpiry = lots.some(l => {
                            if (!l.expiryDate) return false;
                            const d = new Date(l.expiryDate);
                            return d < threshold; // ÊúüÈôêÂàá„Çå„Åæ„Åü„ÅØ60Êó•‰ª•ÂÜÖ
                        });
                    }

                    // „Ç¢„É©„Éº„ÉàÁô∫ÂãïÔºàÂú®Â∫´‰∏çË∂≥ „Åæ„Åü„ÅØ ÊúüÈôêË≠¶ÂëäÔºâ
                    const isAlert = isShortage || hasNearExpiry;
                    // „Ç¢„É©„Éº„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ‰ΩúÊàê
                    const alerts = [];
                    if (hasExpired) alerts.push('‚ö†Ô∏èÊúüÈôêÂàá„Çå„ÅÇ„Çä');
                    else if (hasNearExpiry) alerts.push('‚ö†Ô∏èÊúüÈôêÈñìËøë');

                    if (isShortage) alerts.push('‚ö†Ô∏èÂú®Â∫´‰∏çË∂≥');

                    const alertText = alerts.join(' / ');
                    const hasAnyAlert = alerts.length > 0;

                    return `<li class="item-row" data-id="${item.id}">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            ${lotInfoHtml}
                            ${hasAnyAlert ? `<div style="margin-top:4px;"><span class="item-alert-label">${alertText}</span></div>` : ''}
                        </div>
                        <div class="item-stock" style="${isShortage ? 'color:var(--color-danger); font-weight:bold;' : ''}">${total}${item.unit}</div>
                    </li>`;
                }).join('');
            }
            // ËøΩÂä†„Éú„Çø„É≥
            html += `<li class="item-row add-item-row" onclick="openAddItemModal(${state.catId})"><div class="add-item-icon">+</div><div class="add-item-text">Áî®ÂìÅ„ÇíËøΩÂä†</div></li>`;

            el.itemsList.innerHTML = html;
            el.itemsList.querySelectorAll('.item-row:not(.add-item-row)').forEach(r => r.onclick = () => { state.itemId = +r.dataset.id; showTxModal(); });
            openModal('items');
        }

        function showTxModal() {
            const item = ITEMS.find(i => i.id === state.itemId);
            const lots = getLots(state.deptId, state.itemId);
            const total = lots.reduce((a, l) => a + l.quantity, 0);
            el.txModalTitle.textContent = item.name;
            el.stockValue.textContent = total;
            el.stockUnit.textContent = item.unit;
            el.txQty.value = 1;
            el.txRemarks.value = '';
            el.txDate.value = new Date().toISOString().split('T')[0];
            state.selectedLot = null;
            setTxType('OUT');
            closeModal('items');
            openModal('transaction');
        }

        function setTxType(t) {
            state.txType = t;
            $('btn-type-in').classList.toggle('active', t === 'IN');
            $('btn-type-out').classList.toggle('active', t === 'OUT');
            el.txDateLabel.textContent = t === 'IN' ? 'ÂÖ•Â∫´Êó•' : 'Âá∫Â∫´Êó•';
            const item = ITEMS.find(i => i.id === state.itemId);
            const lots = getLots(state.deptId, state.itemId);
            if (t === 'IN' && item.hasExpiry) {
                el.expiryInputGroup.style.display = 'block';
                el.lotSelectGroup.style.display = 'none';
                const def = new Date(); def.setFullYear(def.getFullYear() + 1);
                el.txExpiry.value = def.toISOString().split('T')[0];
            } else if (t === 'OUT' && item.hasExpiry && lots.length > 0) {
                el.expiryInputGroup.style.display = 'none';
                el.lotSelectGroup.style.display = 'block';
                renderLotList(lots);
            } else {
                el.expiryInputGroup.style.display = 'none';
                el.lotSelectGroup.style.display = 'none';
            }
            // ÁΩ≤ÊâÄÈñìÁßªÂãï„Ç™„Éó„Ç∑„Éß„É≥„ÇíË°®Á§∫
            $('transfer-group').style.display = 'block';
            $('is-transfer').checked = false;
            $('transfer-dept-select').style.display = 'none';
            // ÁßªÂãïÂÖà„ÅÆÈÉ®ÁΩ≤„Çª„É¨„ÇØ„Éà„ÇíÁîüÊàê
            const otherDepts = DEPARTMENTS.filter(d => d.id !== state.deptId);
            $('transfer-dept').innerHTML = otherDepts.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            // ÂÖ•Â∫´/Âá∫Â∫´„ÅßË°®Áèæ„ÇíÂ§âÊõ¥
            if (t === 'IN') {
                $('transfer-checkbox-text').textContent = 'ÁΩ≤ÊâÄÈñìÁßªÂãïÔºà‰ªñÁΩ≤„Åã„Çâ„ÇÇ„Çâ„ÅÜÔºâ';
                $('transfer-label').textContent = '„Å©„Åì„Åã„ÇâÔºü';
            } else {
                $('transfer-checkbox-text').textContent = 'ÁΩ≤ÊâÄÈñìÁßªÂãïÔºà‰ªñÁΩ≤„Å∏„Çè„Åü„ÅôÔºâ';
                $('transfer-label').textContent = '„Å©„Åì„Å∏Ôºü';
            }
            $('is-transfer').onchange = () => {
                $('transfer-dept-select').style.display = $('is-transfer').checked ? 'block' : 'none';
            };
        }

        function renderLotList(lots) {
            lots.sort((a, b) => new Date(a.expiryDate || '9999') - new Date(b.expiryDate || '9999'));
            el.lotList.innerHTML = lots.map((l, i) => `
                <div class="lot-item ${getExpStatus(l.expiryDate) === 'expired' ? 'expired' : ''}" data-idx="${i}">
                    <span>${l.expiryDate || 'ÊúüÈôê„Å™„Åó'}</span>
                    <span>${l.quantity}ÂÄã</span>
                    <button class="edit-expiry-btn" onclick="event.stopPropagation();editLotExpiry('${l.expiryDate || ''}', ${l.quantity})">üìÖ</button>
                </div>`).join('');
            state.selectedLot = null;
            el.lotList.querySelectorAll('.lot-item').forEach(li => li.onclick = () => {
                el.lotList.querySelectorAll('.lot-item').forEach(x => x.classList.remove('selected'));
                li.classList.add('selected');
                state.selectedLot = lots[+li.dataset.idx];
            });
        }

        async function editLotExpiry(oldExpiry, qty) {
            const newExpiry = prompt('Êñ∞„Åó„ÅÑ‰ΩøÁî®ÊúüÈôê„ÇíÂÖ•Âäõ (YYYY-MM-DD)', oldExpiry || new Date().toISOString().split('T')[0]);
            if (newExpiry === null) return; // „Ç≠„É£„É≥„Çª„É´
            showLoading(true);
            try {
                await fsUpdateStockExpiry(state.deptId, state.itemId, oldExpiry || '', newExpiry || '');
                state.stocks = await fsGetStocks();
                const lots = getLots(state.deptId, state.itemId);
                renderLotList(lots);
                alert('‰ΩøÁî®ÊúüÈôê„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            } catch (e) { handleError(e); }
            showLoading(false);
        }

        async function saveTx() {
            const qty = +el.txQty.value;
            const remarks = el.txRemarks.value.trim();
            const item = ITEMS.find(i => i.id === state.itemId);
            if (isNaN(qty) || qty < 1) { alert('Êï∞Èáè„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
            let expiry = null;
            if (state.txType === 'IN' && item.hasExpiry) expiry = el.txExpiry.value || null;
            else if (state.txType === 'OUT' && item.hasExpiry) {
                if (!state.selectedLot) { alert('„É≠„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
                if (state.selectedLot.quantity < qty) { alert('Âú®Â∫´‰∏çË∂≥'); return; }
                expiry = state.selectedLot.expiryDate;
            }

            const isTransfer = $('is-transfer').checked;
            const transferDeptId = isTransfer ? +$('transfer-dept').value : null;

            el.saveBtn.disabled = true;
            showLoading(true);
            try {
                // Êó•‰ªò„Åå‰ªäÊó•„Å™„ÇâÁèæÂú®ÊôÇÂàª„Çí‰ΩøÁî®
                let txDate = el.txDate.value || new Date().toISOString().split('T')[0];
                const today = new Date().toISOString().split('T')[0];
                if (txDate === today) {
                    txDate = new Date().toISOString();
                }

                if (isTransfer) {
                    // ÁΩ≤ÊâÄÈñìÁßªÂãï„ÅÆÂ†¥Âêà
                    const fromDept = state.txType === 'OUT' ? state.deptId : transferDeptId;
                    const toDept = state.txType === 'OUT' ? transferDeptId : state.deptId;
                    const fromDeptName = DEPARTMENTS.find(d => d.id === fromDept)?.name;
                    const toDeptName = DEPARTMENTS.find(d => d.id === toDept)?.name;

                    // ÁßªÂãïÂÖÉ„Åã„ÇâÂá∫Â∫´
                    await fsStockOut(fromDept, state.itemId, expiry, qty, `${toDeptName}„Å∏„Çè„Åü„Åô`, txDate);
                    // ÁßªÂãïÂÖà„Å∏ÂÖ•Â∫´
                    await fsStockIn(toDept, state.itemId, expiry, qty, `${fromDeptName}„Åã„Çâ„ÇÇ„Çâ„ÅÜ`, txDate);
                } else {
                    // ÈÄöÂ∏∏„ÅÆÂÖ•Âá∫Â∫´
                    if (state.txType === 'IN') {
                        await fsStockIn(state.deptId, state.itemId, expiry, qty, remarks, txDate);
                    } else {
                        await fsStockOut(state.deptId, state.itemId, expiry, qty, remarks, txDate);
                    }
                }

                state.stocks = await fsGetStocks();
                renderAnalytics(); // ÂÖ®‰ΩìÁîªÈù¢Êõ¥Êñ∞
                closeModal('transaction');
                showItemsModal();
            } catch (e) { handleError(e); }
            el.saveBtn.disabled = false;
            showLoading(false);
        }

        async function renderAnalytics() {
            showLoading(true);
            // „Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
            const analyticsTitle = document.querySelector('#analytics .department-name');
            if (state.deptId) {
                const dept = DEPARTMENTS.find(d => d.id === state.deptId);
                analyticsTitle.textContent = `${dept?.name || ''} Áµ±Ë®à„ÉªÂàÜÊûê`;
            } else {
                analyticsTitle.textContent = 'ÂÖ®‰ΩìÁµ±Ë®à„ÉªÂàÜÊûê';
            }
            try { state.transactions = await fsGetTransactions(100); renderLog(); renderSummary(); initBudget(); renderBudget(); } catch (e) { handleError(e); }
            showLoading(false);
        }

        function renderLog() {
            // ÈÉ®ÁΩ≤„Éï„Ç£„É´„Çø & Âá∫Â∫´„ÅÆ„Åø
            let txs = state.transactions.filter(t => t.type === 'OUT');
            if (state.deptId) {
                txs = txs.filter(t => t.departmentId === state.deptId);
            }

            if (txs.length === 0) {
                el.logList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
                return;
            }
            el.logList.innerHTML = txs.slice(0, 50).map(tx => {
                const d = DEPARTMENTS.find(x => x.id === tx.departmentId);
                const i = ITEMS.find(x => x.id === tx.itemId);
                const dateLabel = tx.type === 'IN' ? 'ÂÖ•Â∫´Êó•' : 'Âá∫Â∫´Êó•';
                const expStr = tx.expiryDate ? fmtDate(tx.expiryDate) : '';
                return `<div class="log-item"><div class="log-type ${tx.type === 'IN' ? 'in' : 'out'}">${tx.type === 'IN' ? 'ÂÖ•Â∫´' : 'Âá∫Â∫´'}</div><div class="log-details"><div class="log-item-name">${i?.name || '?'}</div><div class="log-meta">${d?.name || '?'} / ${dateLabel}:${fmtDT(tx.timestamp)}${expStr ? ' / ÊúüÈôê:' + expStr : ''}${tx.remarks ? ' / ' + tx.remarks : ''}</div></div><div class="log-quantity">${tx.type === 'IN' ? '+' : '-'}${tx.quantity}</div></div>`;
            }).join('');
        }

        function renderSummary() {
            // ÁâπÂÆöÈÉ®ÁΩ≤„ÅÆÂ†¥ÂêàÔºö„Ç´„ÉÜ„Ç¥„É™Âà•Âú®Â∫´„ÇíË°®Á§∫
            if (state.deptId) {
                renderSummaryByCategory(state.deptId);
            } else {
                // ÂÖ®‰ΩìË°®Á§∫ÔºöÂú®Â∫´„Éû„Éà„É™„ÉÉ„ÇØ„ÇπË°®Á§∫
                renderInventoryMatrix();
            }
        }

        // ------------------------------------------------------------------
        // Âú®Â∫´„Éû„Éà„É™„ÉÉ„ÇØ„ÇπË°®Á§∫
        // ------------------------------------------------------------------
        function renderInventoryMatrix() {
            const container = el.summaryList;

            // CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
            let html = `
                <div class="matrix-controls">
                    <button class="export-btn" style="width: auto; padding: 8px 16px;" onclick="exportMatrixCSV()">
                        <span class="material-symbols-outlined">download</span>CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                    </button>
                </div>
                <div class="matrix-accordion">
            `;

            CATEGORIES.forEach(cat => {
                // „Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´Â±û„Åô„ÇãÁî®ÂìÅ„Åå„ÅÇ„Çã„ÅãÁ¢∫Ë™ç
                const catItems = ITEMS.filter(i => i.categoryId === cat.id);
                if (catItems.length === 0) return;

                html += `
                    <div class="matrix-accordion-item" id="accordion-${cat.id}">
                        <div class="matrix-accordion-header" onclick="toggleMatrixAccordion(${cat.id})">
                            <div class="matrix-accordion-title">
                                <span class="matrix-category-icon material-symbols-outlined" style="color: ${ICON_COLORS[cat.icon] || ''}">${cat.icon}</span>
                                <span>${cat.name}</span>
                            </div>
                            <span class="material-symbols-outlined accordion-toggle-icon">expand_more</span>
                        </div>
                        <div class="matrix-accordion-content">
                            ${renderMatrixTable(catItems)}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function renderMatrixTable(items) {
            // ÁΩ≤ÊâÄ„É™„Çπ„Éà: ÂêÑÁΩ≤ÊâÄ(IDÈ†Ü) -> ÁΩ≤ÊâÄË®à -> Ë≠¶Èò≤Ë™≤
            // Ë≠¶Èò≤Ë™≤ID„ÅØ1„ÄÅ„Åù„ÅÆ‰ªñ„ÅØ2„Äú10
            const keibouka = DEPARTMENTS.find(d => d.id === 1);
            const otherDepts = DEPARTMENTS.filter(d => d.id !== 1).sort((a, b) => a.id - b.id);

            let html = `
                <div class="matrix-table-wrapper">
                    <table class="inventory-matrix-table">
                        <thead>
                            <tr>
                                <th>Áî®ÂìÅÂêç</th>
                                ${otherDepts.map(d => `<th>${d.name}</th>`).join('')}
                                <th class="total-col-header">ÁΩ≤ÊâÄË®à</th>
                                <th class="keibouka-col-header">Ë≠¶Èò≤Ë™≤</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            items.forEach(item => {
                const lots = getLots(null, item.id);
                // ÊúüÈôê„É≠„ÉÉ„ÉàÊÉÖÂ†±„ÅÆÂèéÈõÜ
                const lotsByExp = {};
                // ÊúâÂäπ„Å™ÊúüÈôê„ÇíÊåÅ„Å§„É≠„ÉÉ„Éà„ÇíÊäΩÂá∫
                lots.forEach(l => {
                    // „Éá„Éº„Çø„Å´„Çà„Å£„Å¶„ÅØ expiryDate „Å†„Å£„Åü„Çä expirationDate „Å†„Å£„Åü„Çä„Åô„Çã
                    const expDate = l.expiryDate || l.expirationDate;
                    if (expDate && expDate !== '9999-12-31' && expDate.trim() !== '') {
                        if (!lotsByExp[expDate]) lotsByExp[expDate] = [];
                        lotsByExp[expDate].push(l);
                    }
                });
                const hasExpiry = Object.keys(lotsByExp).length > 0;

                // ÂÖ®‰ΩìË°å„ÅÆË®àÁÆó
                // ÂêÑÁΩ≤ÊâÄ„ÅÆÂú®Â∫´„Å®„É≠„ÉÉ„ÉàÂÜÖË®≥
                const deptQtys = {};
                const deptLotDetails = {}; // ÁΩ≤ÊâÄ„Åî„Å®„ÅÆ„É≠„ÉÉ„ÉàË©≥Á¥∞ HTML

                let subTotal = 0; // Ë≠¶Èò≤Ë™≤‰ª•Â§ñ„ÅÆÂêàË®à
                otherDepts.forEach(d => {
                    const deptLots = lots.filter(l => l.departmentId === d.id && l.quantity > 0);
                    const q = deptLots.reduce((a, b) => a + b.quantity, 0);
                    deptQtys[d.id] = q;
                    subTotal += q;

                    // „É≠„ÉÉ„ÉàÂÜÖË®≥ÁîüÊàê
                    if (q > 0 && hasExpiry) {
                        // ÊúüÈôêÈ†Ü„Å´„ÇΩ„Éº„Éà
                        deptLots.sort((a, b) => {
                            const dateA = a.expiryDate || a.expirationDate || '9999';
                            const dateB = b.expiryDate || b.expirationDate || '9999';
                            return dateA.localeCompare(dateB);
                        });

                        let detailsHtml = '<div class="lot-breakdown">';
                        deptLots.forEach(l => {
                            const expDate = l.expiryDate || l.expirationDate;
                            if (expDate && expDate !== '9999-12-31') {
                                // Êó•‰ªò„ÇíÁü≠Á∏Æ (YYYY-MM-DD -> YY/MM/DD)
                                const shortDate = expDate.substring(2).replace(/-/g, '/');
                                // ÊúüÈôêÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØ
                                const isExp = getExpStatus(expDate) === 'expired';
                                detailsHtml += `<span class="lot-item-matrix ${isExp ? 'expired-lot' : ''}">${shortDate}: ${l.quantity}</span>`;
                            }
                        });
                        detailsHtml += '</div>';
                        // ÂÜÖË®≥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„Çª„ÉÉ„Éà
                        if (deptLots.some(l => {
                            const d = l.expiryDate || l.expirationDate;
                            return d && d !== '9999-12-31';
                        })) {
                            deptLotDetails[d.id] = detailsHtml;
                        }
                    }
                });

                // Ë≠¶Èò≤Ë™≤„ÅÆÂú®Â∫´„Å®„É≠„ÉÉ„ÉàÂÜÖË®≥
                let keiboukaQty = 0;
                let keiboukaDetailsHtml = '';
                if (keibouka) {
                    const kLots = lots.filter(l => l.departmentId === keibouka.id && l.quantity > 0);
                    keiboukaQty = kLots.reduce((a, b) => a + b.quantity, 0);

                    if (keiboukaQty > 0 && hasExpiry) {
                        kLots.sort((a, b) => {
                            const dateA = a.expiryDate || a.expirationDate || '9999';
                            const dateB = b.expiryDate || b.expirationDate || '9999';
                            return dateA.localeCompare(dateB);
                        });

                        keiboukaDetailsHtml = '<div class="lot-breakdown">';
                        kLots.forEach(l => {
                            const expDate = l.expiryDate || l.expirationDate;
                            if (expDate && expDate !== '9999-12-31') {
                                const shortDate = expDate.substring(2).replace(/-/g, '/');
                                const isExp = getExpStatus(expDate) === 'expired';
                                keiboukaDetailsHtml += `<span class="lot-item-matrix ${isExp ? 'expired-lot' : ''}">${shortDate}: ${l.quantity}</span>`;
                            }
                        });
                        keiboukaDetailsHtml += '</div>';
                        // ÊúâÂäπ„Å™ÊúüÈôêË°®Á§∫„Åå„Å™„Åë„Çå„Å∞Á©∫„Å´„Åô„Çã
                        if (!kLots.some(l => {
                            const d = l.expiryDate || l.expirationDate;
                            return d && d !== '9999-12-31';
                        })) {
                            keiboukaDetailsHtml = '';
                        }
                    }
                }

                // „É°„Ç§„É≥Ë°åÊèèÁîª
                html += `<tr class="matrix-item-row">
                    <td class="item-name-cell">
                        <div class="item-name">${item.name}</div>
                        <div class="item-unit">${item.unit}</div>
                    </td>`;

                // ÂêÑÁΩ≤ÊâÄÂàó
                otherDepts.forEach(d => {
                    const q = deptQtys[d.id];
                    const details = deptLotDetails[d.id] || '';
                    html += `<td>
                        ${q > 0 ? `<div class="cell-qty">${q}</div>` : '-'}
                        ${details}
                    </td>`;
                });

                // ÁΩ≤ÊâÄË®à
                html += `<td class="total-col">${subTotal > 0 ? subTotal : '-'}</td>`;

                // Ë≠¶Èò≤Ë™≤
                html += `<td class="keibouka-col">
                    ${keiboukaQty > 0 ? `<div class="cell-qty">${keiboukaQty}</div>` : '-'}
                    ${keiboukaDetailsHtml}
                </td>`;
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;
            return html;
        }

        function toggleMatrixAccordion(catId) {
            const item = document.getElementById(`accordion-${catId}`);
            if (item) {
                item.classList.toggle('open');
            }
        }

        function exportMatrixCSV() {
            // CSVÁîüÊàê„É≠„Ç∏„ÉÉ„ÇØ
            // „Éò„ÉÉ„ÉÄ„Éº: Áî®ÂìÅID, „Ç´„ÉÜ„Ç¥„É™, Áî®ÂìÅÂêç, Âçò‰Ωç, ‰∏âÊ¨°...Êù±Âüé, ÁΩ≤ÊâÄË®à, Ë≠¶Èò≤Ë™≤
            const keibouka = DEPARTMENTS.find(d => d.id === 99);
            const otherDepts = DEPARTMENTS.filter(d => d.id !== 99).sort((a, b) => a.id - b.id);

            let csv = '\uFEFF'; // BOM

            // „Éò„ÉÉ„ÉÄ„ÉºË°å
            const header = ['ID', '„Ç´„ÉÜ„Ç¥„É™', 'Áî®ÂìÅÂêç', 'Âçò‰Ωç', ...otherDepts.map(d => d.name), 'ÁΩ≤ÊâÄË®à', 'Ë≠¶Èò≤Ë™≤'];
            csv += header.join(',') + '\n';

            // „Éá„Éº„ÇøË°å
            ITEMS.forEach(item => {
                const cat = CATEGORIES.find(c => c.id === item.categoryId);
                const lots = getLots(null, item.id);

                const row = [
                    item.id,
                    cat ? cat.name : '',
                    item.name,
                    item.unit
                ];

                let subTotal = 0;
                // ÂêÑÁΩ≤ÊâÄ
                otherDepts.forEach(d => {
                    const qty = lots.filter(l => l.departmentId === d.id).reduce((a, l) => a + l.quantity, 0);
                    row.push(qty);
                    subTotal += qty;
                });

                // ÁΩ≤ÊâÄË®à
                row.push(subTotal);

                // Ë≠¶Èò≤Ë™≤
                const keiboukaQty = keibouka ? lots.filter(l => l.departmentId === keibouka.id).reduce((a, l) => a + l.quantity, 0) : 0;
                row.push(keiboukaQty);

                csv += row.join(',') + '\n';
            });

            // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `ÊïëÊÄ•Áî®ÂìÅÂú®Â∫´Ë°®_${new Date().toISOString().split('T')[0]}.csv`);
            a.click();
        }



        // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´Èñ¢Êï∞ËøΩÂä†ÔºàonclickÂ±ûÊÄß„ÅÆ„Åü„ÇÅÔºâ
        window.toggleMatrixAccordion = toggleMatrixAccordion;
        window.exportMatrixCSV = exportMatrixCSV;
        window.openAddCategoryModal = openAddCategoryModal; // Êó¢Â≠ò„ÅÆ„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„ÇÇÂøµ„ÅÆ„Åü„ÇÅÂÜçÂÆ£Ë®Ä

        // ÁΩ≤ÊâÄÂà•√ó„Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÂú®Â∫´‰∏ÄË¶ß„ÇíË°®Á§∫ÔºàÂâäÈô§‰∫àÂÆö„Å†„Å£„Åü„ÅåÊó¢Â≠ò„É≠„Ç∏„ÉÉ„ÇØ‰∫íÊèõ„ÅÆ„Åü„ÇÅ‰∏ÄÂøúÊÆã„Åô„Åå‰ΩøÁî®„Åó„Å™„ÅÑÔºâ
        function unused_renderSummaryByDepartment() { return; }

        // ÁâπÂÆöÈÉ®ÁΩ≤„ÅÆ„Ç´„ÉÜ„Ç¥„É™Âà•Âú®Â∫´„ÇíË°®Á§∫
        function renderSummaryByCategory(deptId) {
            const deptStocks = state.stocks.filter(s => s.departmentId === deptId && s.quantity > 0);

            // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
            const catData = {};
            CATEGORIES.forEach(c => { catData[c.id] = { category: c, items: [] }; });

            deptStocks.forEach(s => {
                const item = ITEMS.find(i => i.id === s.itemId);
                if (!item || !catData[item.categoryId]) return;
                const existing = catData[item.categoryId].items.find(x => x.item.id === item.id);
                if (existing) {
                    existing.qty += s.quantity;
                    existing.lots.push(s);
                } else {
                    catData[item.categoryId].items.push({ item, qty: s.quantity, lowStock: false, lots: [s] });
                }
            });

            // ÊúÄ‰ΩéÂú®Â∫´„ÉÅ„Çß„ÉÉ„ÇØ
            Object.values(catData).forEach(c => {
                c.items.forEach(s => {
                    if (s.item.minStock && s.qty < s.item.minStock) {
                        s.lowStock = true;
                    }
                });
            });

            const catsWithItems = Object.values(catData).filter(c => c.items.length > 0);
            if (catsWithItems.length === 0) {
                el.summaryList.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p>Âú®Â∫´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p></div>';
                return;
            }

            el.summaryList.innerHTML = catsWithItems.map(c => {
                const catColor = ICON_COLORS[c.category.icon] || '#607D8B';
                const itemsHtml = c.items.map(s => {
                    const lowClass = s.lowStock ? 'low-stock' : '';
                    const minLabel = s.item.minStock ? `<span class="min-stock-label">ÊúÄ‰Ωé:${s.item.minStock}</span>` : '';

                    // „É≠„ÉÉ„ÉàÊÉÖÂ†±„ÅÆË°®Á§∫ÔºàÊúüÈôê‰ªò„Åç„ÅÆ„ÅøÔºâ
                    let lotInfoHtml = '';
                    if (s.item.hasExpiry && s.lots.length > 0) {
                        const sortedLots = [...s.lots].sort((a, b) => (a.expiryDate || '9999').localeCompare(b.expiryDate || '9999'));
                        lotInfoHtml = `<div class="lot-tags">` +
                            sortedLots.map(l => {
                                const isExp = getExpStatus(l.expiryDate) === 'expired';
                                return `<span class="lot-tag ${isExp ? 'expired' : ''}">${l.expiryDate || 'ÊúüÈôê„Å™„Åó'}: ${l.quantity}</span>`;
                            }).join('') + `</div>`;
                    }

                    return `<div class="summary-item ${lowClass}">
                        <div class="summary-item-header">
                            <div>
                                <span class="summary-item-name">${s.item.name} ${minLabel}</span>
                                ${lotInfoHtml}
                            </div>
                            <span class="summary-item-total">${s.qty}${s.item.unit}</span>
                        </div>
                    </div>`;
                }).join('');

                return `<div class="summary-category" style="border-left: 4px solid ${catColor}">
                    <div class="summary-category-header">
                        <span class="material-symbols-outlined" style="color:${catColor}">${c.category.icon}</span>
                        <span>${c.category.name}</span>
                    </div>
                    ${itemsHtml}
                </div>`;
            }).join('');
        }

        function initBudget() {
            const yrs = new Set();
            state.transactions.forEach(t => {
                const year = new Date(t.timestamp).getFullYear();
                if (!isNaN(year) && year > 2000 && year < 2100) {
                    yrs.add(year);
                }
            });
            yrs.add(new Date().getFullYear());
            el.budgetYear.innerHTML = [...yrs].sort((a, b) => b - a).map(y => `<option value="${y}">${y}Âπ¥</option>`).join('');
            el.budgetMonth.innerHTML = '<option value="all">ÂÖ®ÊúüÈñì</option>' + [...Array(12)].map((_, i) => `<option value="${i + 1}">${i + 1}Êúà</option>`).join('');
        }

        function renderBudget() {
            const yr = +el.budgetYear.value, mo = el.budgetMonth.value;
            // ÈÉ®ÁΩ≤„Éï„Ç£„É´„Çø
            let flt = state.transactions.filter(t => t.type === 'OUT' && new Date(t.timestamp).getFullYear() === yr && (mo === 'all' || new Date(t.timestamp).getMonth() + 1 === +mo));
            if (state.deptId) {
                flt = flt.filter(t => t.departmentId === state.deptId);
            }

            if (state.deptId) {
                // ÈÉ®ÁΩ≤Âà•Ë°®Á§∫: „Ç∑„É≥„Éó„É´„Å™„É™„Çπ„ÉàÂΩ¢Âºè
                const mx = {}; ITEMS.forEach(i => { mx[i.id] = 0; });
                flt.forEach(t => { mx[t.itemId] = (mx[t.itemId] || 0) + t.quantity; });
                const used = ITEMS.filter(i => mx[i.id] > 0);
                if (used.length === 0) { el.budgetTable.innerHTML = '<tr><td colspan="2" style="padding:2rem;text-align:center">„Éá„Éº„Çø„Å™„Åó</td></tr>'; return; }
                let h = '<thead><tr><th>Áî®ÂìÅ</th><th>‰ΩøÁî®Êï∞</th></tr></thead><tbody>';
                used.forEach(i => { h += `<tr><td>${i.name}</td><td><b>${mx[i.id]}</b></td></tr>`; });
                h += '</tbody>'; el.budgetTable.innerHTML = h;
            } else {
                // ÂÖ®‰ΩìË°®Á§∫: ÈÉ®ÁΩ≤Âà•„ÇØ„É≠„ÇπÈõÜË®à
                const mx = {}; DEPARTMENTS.forEach(d => { mx[d.id] = {}; ITEMS.forEach(i => { mx[d.id][i.id] = 0; }); });
                flt.forEach(t => { if (mx[t.departmentId]) mx[t.departmentId][t.itemId] = (mx[t.departmentId][t.itemId] || 0) + t.quantity; });
                const used = ITEMS.filter(i => flt.some(t => t.itemId === i.id));
                if (used.length === 0) { el.budgetTable.innerHTML = '<tr><td colspan="12" style="padding:2rem;text-align:center">„Éá„Éº„Çø„Å™„Åó</td></tr>'; return; }
                let h = '<thead><tr><th>Áî®ÂìÅ</th>' + DEPARTMENTS.map(d => `<th>${d.name}</th>`).join('') + '<th>Ë®à</th></tr></thead><tbody>';
                used.forEach(i => { h += `<tr><td>${i.name}</td>`; let rt = 0; DEPARTMENTS.forEach(d => { const q = mx[d.id][i.id] || 0; rt += q; h += `<td>${q || '-'}</td>`; }); h += `<td><b>${rt}</b></td></tr>`; });
                h += '</tbody>'; el.budgetTable.innerHTML = h;
            }
        }

        function exportCSV() {
            const yr = el.budgetYear.value, mo = el.budgetMonth.value;
            let flt = state.transactions.filter(t => t.type === 'OUT' && new Date(t.timestamp).getFullYear() === +yr && (mo === 'all' || new Date(t.timestamp).getMonth() + 1 === +mo));
            if (state.deptId) {
                flt = flt.filter(t => t.departmentId === state.deptId);
                const dept = DEPARTMENTS.find(d => d.id === state.deptId);
                const mx = {}; ITEMS.forEach(i => { mx[i.id] = 0; });
                flt.forEach(t => { mx[t.itemId] = (mx[t.itemId] || 0) + t.quantity; });
                let csv = '\ufeffÁî®ÂìÅÂêç,‰ΩøÁî®Êï∞\n';
                ITEMS.forEach(i => { if (mx[i.id] > 0) csv += `"${i.name}",${mx[i.id]}\n`; });
                const b = new Blob([csv], { type: 'text/csv;charset=utf-8' }), u = URL.createObjectURL(b), a = document.createElement('a');
                a.href = u; a.download = `${dept?.name || 'ÈÉ®ÁΩ≤'}_‰ΩøÁî®Èáè_${yr}Âπ¥${mo === 'all' ? '' : mo + 'Êúà'}.csv`; a.click(); URL.revokeObjectURL(u);
            } else {
                const mx = {}; ITEMS.forEach(i => { mx[i.id] = {}; DEPARTMENTS.forEach(d => { mx[i.id][d.id] = 0; }); }); flt.forEach(t => { mx[t.itemId][t.departmentId] += t.quantity; });
                let csv = '\ufeffÁî®ÂìÅÂêç,' + DEPARTMENTS.map(d => d.name).join(',') + ',ÂêàË®à\n';
                ITEMS.forEach(i => { const vs = DEPARTMENTS.map(d => mx[i.id][d.id]); const t = vs.reduce((a, b) => a + b, 0); if (t > 0) csv += `"${i.name}",${vs.join(',')},${t}\n`; });
                const b = new Blob([csv], { type: 'text/csv;charset=utf-8' }), u = URL.createObjectURL(b), a = document.createElement('a'); a.href = u; a.download = `EMS‰ΩøÁî®Èáè_${yr}Âπ¥${mo === 'all' ? '' : mo + 'Êúà'}.csv`; a.click(); URL.revokeObjectURL(u);
            }
        }

        function switchTab(id) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === id)); document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === 'tab-' + id)); }

        function renderSettings() {
            if (state.settingsCatId) {
                renderSettingsItems(state.settingsCatId);
            } else {
                renderSettingsCategories();
            }
        }

        function renderSettingsCategories() {
            let h = '<div class="settings-section"><h3 class="section-title">„Ç´„ÉÜ„Ç¥„É™‰∏ÄË¶ß <button class="settings-add-btn" onclick="openAddCategoryModal()">ÔºãËøΩÂä†</button></h3><div class="settings-list">';
            if (CATEGORIES.length === 0) h += '<p style="color:var(--color-text-muted)">„Ç´„ÉÜ„Ç¥„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            else {
                h += CATEGORIES.map(c => `
                    <div class="settings-item" onclick="state.settingsCatId=${c.id};renderSettings()">
                        <span class="settings-item-name"><span class="material-symbols-outlined" style="color: ${ICON_COLORS[c.icon] || ''}">${c.icon}</span> ${c.name}</span>
                        <div class="settings-actions">
                            <button class="icon-btn" onclick="event.stopPropagation();editCategory(${c.id})"><span class="material-symbols-outlined">edit</span></button>
                            <button class="delete-btn" onclick="event.stopPropagation();deleteCategory(${c.id})">√ó</button>
                        </div>
                    </div>`).join('');
            }
            h += '</div></div>';
            el.settingsContainer.innerHTML = h;
        }

        function renderSettingsItems(catId) {
            const cat = CATEGORIES.find(c => c.id === catId);
            if (!cat) { state.settingsCatId = null; renderSettings(); return; }
            const items = ITEMS.filter(i => i.categoryId === catId);
            let h = `<div class="settings-section">
                <div style="display:flex;align-items:center;margin-bottom:1rem;">
                    <button class="back-btn" onclick="state.settingsCatId=null;renderSettings()" style="margin-right:1rem;font-size:1.2rem;">‚Üê</button>
                    <h3 class="section-title" style="margin:0"><span class="material-symbols-outlined" style="color:${ICON_COLORS[cat.icon] || ''};vertical-align:bottom;">${cat.icon}</span> ${cat.name}</h3>
                </div>
                <div style="margin-bottom:1rem;text-align:right;"><button class="btn-sm" onclick="openAddItemModal(${catId})">Ôºã„Åì„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´Áî®ÂìÅËøΩÂä†</button></div>
                <div class="settings-list">`;

            if (items.length === 0) h += '<p style="color:var(--color-text-muted)">Áî®ÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            else {
                h += items.map(i => `
                    <div class="settings-item" onclick="editItem(${i.id})">
                        <span class="settings-item-name">${i.name}</span>
                        <div class="settings-actions">
                             <button class="delete-btn" onclick="event.stopPropagation();deleteItemSetting(${i.id})">√ó</button>
                        </div>
                    </div>`).join('');
            }
            h += '</div></div>';
            el.settingsContainer.innerHTML = h;
        }

        function openAddCategoryModal() {
            state.editingCategoryId = null;
            el.addCategoryModalTitle.textContent = '„Ç´„ÉÜ„Ç¥„É™ËøΩÂä†';
            $('new-category-name').value = '';
            $('new-category-icon').value = ICONS[0];
            renderIconGrid();
            openModal('addCategory');
        }

        function openAddItemModal(catId) {
            state.editingItemId = null;
            el.addItemModalTitle.textContent = 'Áî®ÂìÅËøΩÂä†';
            populateCatSelect();
            if (catId) {
                $('new-item-category').value = catId;
                $('new-item-category').disabled = true;
            } else {
                $('new-item-category').disabled = false;
            }
            $('new-item-name').value = '';
            $('new-item-unit').value = 'ÂÄã';
            $('new-item-has-expiry').checked = false;
            $('new-item-min-stock').value = 0;
            openModal('addItem');
        }

        function editItem(id) {
            const i = ITEMS.find(x => x.id === id);
            if (!i) return;
            state.editingItemId = id;
            el.addItemModalTitle.textContent = 'Áî®ÂìÅÁ∑®ÈõÜ';
            populateCatSelect();
            $('new-item-category').value = i.categoryId;
            $('new-item-category').disabled = false;
            $('new-item-name').value = i.name;
            $('new-item-unit').value = i.unit;
            $('new-item-has-expiry').checked = i.hasExpiry;
            $('new-item-min-stock').value = i.minStock || 0;
            openModal('addItem');
        }

        function editCategory(id) {
            const c = CATEGORIES.find(x => x.id === id);
            if (!c) return;
            state.editingCategoryId = id;
            el.addCategoryModalTitle.textContent = '„Ç´„ÉÜ„Ç¥„É™Á∑®ÈõÜ';
            $('new-category-name').value = c.name;
            $('new-category-icon').value = c.icon;
            renderIconGrid();
            openModal('addCategory');
        }

        function renderIconGrid() {
            el.newCategoryIconGrid.innerHTML = ICONS.map(icon => `<div class="icon-option ${icon === el.newCategoryIconInput.value ? 'selected' : ''}" style="color: ${ICON_COLORS[icon] || ''}"><span class="material-symbols-outlined">${icon}</span></div>`).join('');
            el.newCategoryIconGrid.querySelectorAll('.icon-option').forEach(opt => opt.onclick = () => {
                el.newCategoryIconGrid.querySelectorAll('.icon-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                el.newCategoryIconInput.value = opt.querySelector('span').textContent;
            });
        }

        function populateCatSelect() { $('new-item-category').innerHTML = CATEGORIES.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); }

        async function saveNewCategory() {
            const n = $('new-category-name').value.trim();
            const ic = $('new-category-icon').value || ICONS[0];
            if (!n) { alert('„Ç´„ÉÜ„Ç¥„É™Âêç„ÇíÂÖ•Âäõ'); return; }
            showLoading(true);
            try {
                let c;
                if (state.editingCategoryId) {
                    c = await fsUpdateCategory(state.editingCategoryId, n, ic);
                    const idx = CATEGORIES.findIndex(x => x.id === state.editingCategoryId);
                    if (idx >= 0) CATEGORIES[idx] = c;
                } else {
                    c = await fsAddCategory(n, ic);
                    CATEGORIES.push(c);
                }
                closeModal('addCategory');
                renderSettings();
                renderCatGrid();
                $('new-category-name').value = '';
            } catch (e) { handleError(e); }
            showLoading(false);
        }


        async function saveNewItem() {
            const cid = +$('new-item-category').value;
            const n = $('new-item-name').value.trim();
            const u = $('new-item-unit').value.trim() || 'ÂÄã';
            const he = $('new-item-has-expiry').checked;
            const ms = +$('new-item-min-stock').value || 0;
            if (!n) { alert('Áî®ÂìÅÂêç„ÇíÂÖ•Âäõ'); return; }
            showLoading(true);
            try {
                let i;
                if (state.editingItemId) {
                    i = await fsUpdateItem(state.editingItemId, cid, n, u, he, ms);
                    const idx = ITEMS.findIndex(x => x.id === state.editingItemId);
                    if (idx >= 0) ITEMS[idx] = i;
                } else {
                    i = await fsAddItem(cid, n, u, he, ms);
                    // ÂûãÂ§âÊèõ„ÇíÁ¢∫ÂÆü„Å´Ë°å„ÅÜ
                    i.id = +i.id;
                    i.categoryId = +i.categoryId;
                    i.minStock = +i.minStock;
                    i.hasExpiry = !!i.hasExpiry;
                    ITEMS.push(i);
                }
                closeModal('addItem');
                renderSettings();
                // Áî®ÂìÅ‰∏ÄË¶ßÁîªÈù¢„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÅüÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Êõ¥Êñ∞
                if (state.catId === cid) {
                    showItemsModal();
                }
                $('new-item-name').value = '';
            } catch (e) { handleError(e); }
            showLoading(false);
        }

        async function deleteCategory(id) {
            if (!confirm('„Ç´„ÉÜ„Ç¥„É™„Å®Áî®ÂìÅ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            showLoading(true);
            try { await fsDeleteCategory(id); CATEGORIES = CATEGORIES.filter(c => c.id !== id); ITEMS = ITEMS.filter(i => i.categoryId !== id); renderSettings(); renderCatGrid(); } catch (e) { handleError(e); }
            showLoading(false);
        }

        async function deleteItemSetting(id) {
            if (!confirm('Áî®ÂìÅ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
            showLoading(true);
            try { await fsDeleteItem(id); ITEMS = ITEMS.filter(i => i.id !== id); renderSettings(); } catch (e) { handleError(e); }
            showLoading(false);
        }

        function getLots(deptId, itemId) { return state.stocks.filter(s => (deptId === null || s.departmentId === deptId) && s.itemId === itemId && s.quantity > 0); }
        function getExpStatus(d) { if (!d) return 'none'; const t = new Date(); t.setHours(0, 0, 0, 0); return Math.ceil((new Date(d) - t) / 864e5) < 0 ? 'expired' : 'ok'; }
        function fmtDT(s) {
            if (!s) return '-';
            const d = new Date(s);
            if (isNaN(d.getTime())) return s;
            return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        }
        function fmtDate(s) {
            if (!s) return '';
            // YYYY-MM-DDÂΩ¢Âºè„Å™„Çâ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
            const d = new Date(s);
            if (isNaN(d.getTime())) return s;
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }
        function handleError(e) { showLoading(false); console.error(e); alert('„Ç®„É©„Éº: ' + (e.message || e)); }
    </script>
</body>

</html>